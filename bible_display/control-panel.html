<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBS Bible Free Version - Control Panel</title>
    <link rel="stylesheet" href="../common/css/style-control_panel.css">
    <link rel="stylesheet" href="../common/css/cp-icons.css">
    <link rel="stylesheet" href="../common/css/themes/dark/theme.css">
    <script src="../common/js/jquery.js"></script>
    <script src="../common/js/jscolor.js"></script>
    <!-- Bible data (pre-generated JS files, works with file:// protocol) -->
    <script src="../bible-versions/js/versions-index.js"></script>
    <script src="../bible-versions/js/book_name_mapping.js"></script>
    <script src="../bible-versions/js/LSG.js"></script>
    <script src="../bible-versions/js/KJV.js"></script>
    <script src="../bible-versions/js/WEB.js"></script>
    <script src="../common/js/bible-api.js"></script>
</head>
<body>
    <!-- ===== SEARCH TAB (main view) ===== -->
    <div class="tab-content" id="tabSearch">
        <div class="container">
            <div class="main-panel">
                <h1 data-i18n="searchTitle">Bible Query</h1>

                <!-- Bible Selection -->
                <div class="form-group">
                    <label for="bibleSelect" data-i18n="labelBible">Bible:</label>
                    <select id="bibleSelect" class="form-control">
                        <!-- Options populated dynamically -->
                    </select>
                </div>

                <!-- Reference Input with Autocomplete -->
                <div class="form-group">
                    <label for="referenceInput" data-i18n="labelReference">Reference:</label>
                    <div class="reference-input-wrapper">
                        <input type="text" id="referenceInput" class="form-control" 
                               data-i18n-placeholder="placeholderBook" placeholder="Type a book name..." autocomplete="off">
                    </div>
                </div>

                <!-- Autocomplete Dropdown -->
                <div id="autocompleteDropdown" class="autocomplete-dropdown">
                    <div id="autocompleteList" class="autocomplete-list">
                        <!-- Items populated dynamically -->
                    </div>
                </div>

                <!-- Submit Button -->
                <button id="displayBtn" class="btn btn-primary" data-i18n="btnSubmit">Submit</button>
            </div>
        </div>
    </div>

    <!-- ===== BIBLE TAB ===== -->
    <div class="tab-content" id="tabBible" style="display:none;">
        <div class="container bible-container">
            <div class="main-panel bible-panel">
                <div class="bible-header">
                    <button id="bibleBackBtn" class="btn-back" title="Retour">&#8592;</button>
                    <h2 id="bibleTitle">Bible</h2>
                    <div class="bible-toolbar">
                        <button id="btnPrevChapter" class="toolbar-btn" data-i18n-title="titlePrevChapter" title="Chapitre pr√©c√©dent">&#9664;</button>
                        <button id="btnNextChapter" class="toolbar-btn" data-i18n-title="titleNextChapter" title="Chapitre suivant">&#9654;</button>
                        <button id="btnPrevVerse" class="toolbar-btn" data-i18n-title="titlePrevVerse" title="Verset pr√©c√©dent (‚Üë)">&#8593;</button>
                        <button id="btnNextVerse" class="toolbar-btn" data-i18n-title="titleNextVerse" title="Verset suivant (‚Üì)">&#8595;</button>
                        <button id="btnAddToList" class="toolbar-btn toolbar-btn-add" data-i18n-title="titleAddFav" title="Ajouter aux favoris (+)">&#43;</button>
                    </div>
                </div>
                <div id="versesContainer" class="verses-container">
                    <!-- Verses displayed here -->
                    <p class="empty-msg" data-i18n="emptyVerses">No verses selected.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== LIST TAB ===== -->
    <div class="tab-content" id="tabList" style="display:none;">
        <div class="container bible-container">
            <div class="main-panel bible-panel">
                <div class="bible-header">
                    <h2 style="flex:1;" data-i18n="listTitle">Favorites</h2>
                    <button id="btnClearList" class="toolbar-btn toolbar-btn-danger" data-i18n-title="titleDeleteAll" title="Delete all">üóëÔ∏è</button>
                </div>
                <div id="favoritesContainer" class="favorites-container">
                    <p class="empty-msg" id="emptyFavMsg" data-i18n-html="emptyFavorites">No favorites yet. Use the <strong>+</strong> button to add verses.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== THEME TAB ===== -->
    <div class="tab-content" id="tabTheme" style="display:none;">
        <div class="container">
            <div class="main-panel">
                <h1 data-i18n="themeTitle">Theme</h1>
                <p class="section-desc" data-i18n="themeDesc">Choose a theme for the Bible display (browser source).</p>
                <div class="theme-grid">
                    <div class="theme-card" data-theme="classic-dark">
                        <div class="theme-preview" style="background:linear-gradient(135deg,#1e1e32,#2d2d46);border-top:3px solid #0a84ff;">
                            <span style="color:#0a84ff;font-size:10px;font-weight:700;">JEAN 3:16</span>
                            <span style="color:#e8e8e8;font-size:9px;">Car Dieu a tant aim√©...</span>
                        </div>
                        <span class="theme-name">Classic Dark</span>
                    </div>
                    <div class="theme-card" data-theme="royal-purple">
                        <div class="theme-preview" style="background:linear-gradient(135deg,#30104a,#481c6e);border-top:3px solid #b44dff;">
                            <span style="color:#d89eff;font-size:10px;font-weight:700;">JEAN 3:16</span>
                            <span style="color:#f0e6ff;font-size:9px;">Car Dieu a tant aim√©...</span>
                        </div>
                        <span class="theme-name">Royal Purple</span>
                    </div>
                    <div class="theme-card" data-theme="warm-gold">
                        <div class="theme-preview" style="background:linear-gradient(135deg,#32230a,#4b3714);border-top:3px solid #d4a017;">
                            <span style="color:#f5c842;font-size:10px;font-weight:700;">JEAN 3:16</span>
                            <span style="color:#faebd7;font-size:9px;">Car Dieu a tant aim√©...</span>
                        </div>
                        <span class="theme-name">Warm Gold</span>
                    </div>
                    <div class="theme-card" data-theme="ocean-blue">
                        <div class="theme-preview" style="background:linear-gradient(135deg,#0a1e3c,#0f325a);border-top:3px solid #00b4d8;">
                            <span style="color:#48cae4;font-size:10px;font-weight:700;">JEAN 3:16</span>
                            <span style="color:#caf0f8;font-size:9px;">Car Dieu a tant aim√©...</span>
                        </div>
                        <span class="theme-name">Ocean Blue</span>
                    </div>
                    <div class="theme-card" data-theme="clean-white">
                        <div class="theme-preview" style="background:linear-gradient(135deg,#f5f5f5,#ffffff);border-top:3px solid #333;">
                            <span style="color:#222;font-size:10px;font-weight:700;">JEAN 3:16</span>
                            <span style="color:#333;font-size:9px;">Car Dieu a tant aim√©...</span>
                        </div>
                        <span class="theme-name">Clean White</span>
                    </div>
                    <div class="theme-card" data-theme="forest-green">
                        <div class="theme-preview" style="background:linear-gradient(135deg,#0f2819,#193c23);border-top:3px solid #2ecc71;">
                            <span style="color:#55efc4;font-size:10px;font-weight:700;">JEAN 3:16</span>
                            <span style="color:#d4efdf;font-size:9px;">Car Dieu a tant aim√©...</span>
                        </div>
                        <span class="theme-name">Forest Green</span>
                    </div>
                    <div class="theme-card" data-theme="crimson">
                        <div class="theme-preview" style="background:linear-gradient(135deg,#370a0f,#551419);border-top:3px solid #e74c3c;">
                            <span style="color:#ff7675;font-size:10px;font-weight:700;">JEAN 3:16</span>
                            <span style="color:#fce4e4;font-size:9px;">Car Dieu a tant aim√©...</span>
                        </div>
                        <span class="theme-name">Crimson</span>
                    </div>
                    <div class="theme-card" data-theme="transparent">
                        <div class="theme-preview" style="background:rgba(0,0,0,0.55);border-top:none;">
                            <span style="color:#fff;font-size:10px;font-weight:700;">JEAN 3:16</span>
                            <span style="color:#f0f0f0;font-size:9px;">Car Dieu a tant aim√©...</span>
                        </div>
                        <span class="theme-name">Transparent</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== SETTINGS TAB ===== -->
    <div class="tab-content" id="tabSettings" style="display:none;">
        <div class="container">
            <div class="main-panel settings-panel">
                <h1 data-i18n="settingsTitle">Settings</h1>

                <!-- Language -->
                <div class="setting-row">
                    <div class="setting-info">
                        <span class="setting-title" data-i18n="settingLanguage">Language</span>
                        <span class="setting-desc" data-i18n="settingLanguageDesc">Interface language for the control panel.</span>
                    </div>
                    <div class="setting-control">
                        <select id="languageSelect" class="setting-select">
                            <option value="fr">Fran√ßais</option>
                            <option value="en">English</option>
                        </select>
                    </div>
                </div>

                <!-- Reference Font Size -->
                <div class="setting-row">
                    <div class="setting-info">
                        <span class="setting-title" data-i18n="settingRefFontSize">Reference Font Size</span>
                        <span class="setting-desc" data-i18n="settingRefFontSizeDesc">Scales the font size of the verse reference display.</span>
                    </div>
                    <div class="setting-control">
                        <div class="spin-control">
                            <input type="number" id="refFontSizeInput" class="spin-input" value="20" min="10" max="48">
                            <div class="spin-buttons">
                                <button class="spin-up" id="refFontIncrease">‚ñ≤</button>
                                <button class="spin-down" id="refFontDecrease">‚ñº</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Verse Font Size -->
                <div class="setting-row">
                    <div class="setting-info">
                        <span class="setting-title" data-i18n="settingVerseFontSize">Verse Font Size</span>
                        <span class="setting-desc" data-i18n="settingVerseFontSizeDesc">Scales the font size of displayed Bible verses.</span>
                    </div>
                    <div class="setting-control">
                        <div class="spin-control">
                            <input type="number" id="verseFontSizeInput" class="spin-input" value="18" min="10" max="48">
                            <div class="spin-buttons">
                                <button class="spin-up" id="verseFontIncrease">‚ñ≤</button>
                                <button class="spin-down" id="verseFontDecrease">‚ñº</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Line Spacing -->
                <div class="setting-row">
                    <div class="setting-info">
                        <span class="setting-title" data-i18n="settingLineSpacing">Line Spacing</span>
                        <span class="setting-desc" data-i18n="settingLineSpacingDesc">Controls the line height of the verse text.</span>
                    </div>
                    <div class="setting-control">
                        <div class="spin-control">
                            <input type="number" id="lineHeightInput" class="spin-input" value="1.6" min="1.0" max="3.0" step="0.1">
                            <div class="spin-buttons">
                                <button class="spin-up" id="lineHeightIncrease">‚ñ≤</button>
                                <button class="spin-down" id="lineHeightDecrease">‚ñº</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Maximum number of lines -->
                <div class="setting-row">
                    <div class="setting-info">
                        <span class="setting-title" data-i18n="settingMaxLines">Maximum number of lines</span>
                        <span class="setting-desc" data-i18n="settingMaxLinesDesc">Splits Bible verses into different slides if there are too many lines. Leave at 0 for no limit.</span>
                    </div>
                    <div class="setting-control">
                        <div class="spin-control">
                            <input type="number" id="maxLinesInput" class="spin-input" value="0" min="0" max="10">
                            <div class="spin-buttons">
                                <button class="spin-up" id="maxLinesIncrease">‚ñ≤</button>
                                <button class="spin-down" id="maxLinesDecrease">‚ñº</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Opacity -->
                <div class="setting-row">
                    <div class="setting-info">
                        <span class="setting-title" data-i18n="settingOpacity">Opacity</span>
                        <span class="setting-desc" data-i18n="settingOpacityDesc">Controls the transparency of the verse display block.</span>
                    </div>
                    <div class="setting-control">
                        <div class="spin-control">
                            <input type="number" id="opacityInput" class="spin-input" value="100" min="10" max="100" step="5">
                            <div class="spin-buttons">
                                <button class="spin-up" id="opacityIncrease">‚ñ≤</button>
                                <button class="spin-down" id="opacityDecrease">‚ñº</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Text Alignment -->
                <div class="setting-row">
                    <div class="setting-info">
                        <span class="setting-title" data-i18n="settingAlignment">Text Alignment</span>
                        <span class="setting-desc" data-i18n="settingAlignmentDesc">Sets the text alignment for the verse display.</span>
                    </div>
                    <div class="setting-control">
                        <select id="alignmentSelect" class="setting-select">
                            <option value="left" data-i18n="alignLeft">Left</option>
                            <option value="center" selected data-i18n="alignCenter">Center</option>
                            <option value="right" data-i18n="alignRight">Right</option>
                        </select>
                    </div>
                </div>

                <!-- Transition Effect -->
                <div class="setting-row">
                    <div class="setting-info">
                        <span class="setting-title" data-i18n="settingTransition">Transition Effect</span>
                        <span class="setting-desc" data-i18n="settingTransitionDesc">Animation used when displaying and hiding verses.</span>
                    </div>
                    <div class="setting-control">
                        <select id="transitionSelect" class="setting-select">
                            <option value="fade" data-i18n="transFade">Fade</option>
                            <option value="slide-up" data-i18n="transSlideUp">Slide Up</option>
                            <option value="slide-down" data-i18n="transSlideDown">Slide Down</option>
                            <option value="slide-left" data-i18n="transSlideLeft">Slide Left</option>
                            <option value="zoom" data-i18n="transZoom">Zoom</option>
                            <option value="none" data-i18n="transNone">None</option>
                        </select>
                    </div>
                </div>

                <!-- Auto-hide -->
                <div class="setting-row">
                    <div class="setting-info">
                        <span class="setting-title" data-i18n="settingAutoHide">Auto-hide Verse</span>
                        <span class="setting-desc" data-i18n="settingAutoHideDesc">Automatically hides the verse after a set duration.</span>
                    </div>
                    <div class="setting-control">
                        <label class="toggle-switch">
                            <input type="checkbox" id="autoHideToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- Auto-hide Timer -->
                <div class="setting-row" id="autoHideTimerSection" style="display:none;">
                    <div class="setting-info">
                        <span class="setting-title" data-i18n="settingAutoHideDelay">Auto-hide Delay</span>
                        <span class="setting-desc" data-i18n="settingAutoHideDelayDesc">Number of seconds before the verse disappears.</span>
                    </div>
                    <div class="setting-control">
                        <div class="spin-control">
                            <input type="number" id="timerInput" class="spin-input" value="5" min="2" max="20">
                            <div class="spin-buttons">
                                <button class="spin-up" id="timerIncrease">‚ñ≤</button>
                                <button class="spin-down" id="timerDecrease">‚ñº</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Current Theme -->
                <div class="setting-row">
                    <div class="setting-info">
                        <span class="setting-title" data-i18n="settingTheme">Current Theme</span>
                        <span class="setting-desc" data-i18n="settingThemeDesc">Visual style applied to the browser source display.</span>
                    </div>
                    <div class="setting-control">
                        <div class="theme-select-row">
                            <span id="currentThemeName" class="current-theme-label">Classic Dark</span>
                            <button id="goToThemes" class="btn-link" data-i18n="btnChange">Change ‚Üí</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation Bar -->
    <div class="bottom-nav">
        <button class="nav-btn active" data-tab="tabSearch">
            <span class="icon">üîç</span>
            <span class="label" data-i18n="navSearch">Search</span>
        </button>
        <button class="nav-btn" data-tab="tabBible">
            <span class="icon">üìñ</span>
            <span class="label" data-i18n="navBible">Bible</span>
        </button>
        <button class="nav-btn" data-tab="tabList">
            <span class="icon">‚ò∞</span>
            <span class="label" data-i18n="navList">List</span>
        </button>
        <button class="nav-btn" data-tab="tabTheme">
            <span class="icon">üé®</span>
            <span class="label" data-i18n="navTheme">Theme</span>
        </button>
        <button class="nav-btn" data-tab="tabSettings">
            <span class="icon">‚öôÔ∏è</span>
            <span class="label" data-i18n="navSettings">Settings</span>
        </button>
    </div>

    <script>
        // ====== i18n ======
        const i18n = {
            fr: {
                // Search tab
                searchTitle: 'Recherche Biblique',
                labelBible: 'Bible :',
                labelReference: 'R√©f√©rence :',
                placeholderBook: 'Tapez un nom de livre...',
                btnSubmit: 'Afficher',
                // Bible tab
                emptyVerses: 'Aucun verset s√©lectionn√©.',
                // List tab
                listTitle: 'Favoris',
                titleDeleteAll: 'Tout supprimer',
                emptyFavorites: 'Aucun favori. Utilisez le bouton <strong>+</strong> pour ajouter des versets.',
                favRemove: 'Supprimer',
                // Theme tab
                themeTitle: 'Th√®me',
                themeDesc: 'Choisissez un th√®me pour l\'affichage biblique (source navigateur).',
                // Settings tab
                settingsTitle: 'Param√®tres',
                settingLanguage: 'Langue',
                settingLanguageDesc: 'Langue de l\'interface du panneau de contr√¥le.',
                settingRefFontSize: 'Taille police r√©f√©rence',
                settingRefFontSizeDesc: 'Taille de la police pour la r√©f√©rence du verset.',
                settingVerseFontSize: 'Taille police verset',
                settingVerseFontSizeDesc: 'Taille de la police pour le texte des versets.',
                settingLineSpacing: 'Interligne',
                settingLineSpacingDesc: 'Contr√¥le la hauteur de ligne du texte.',
                settingMaxLines: 'Nombre max. de lignes',
                settingMaxLinesDesc: 'Divise les versets en diapositives si trop de lignes. 0 = pas de limite.',
                settingOpacity: 'Opacit√©',
                settingOpacityDesc: 'Contr√¥le la transparence du bloc d\'affichage.',
                settingAlignment: 'Alignement du texte',
                settingAlignmentDesc: 'D√©finit l\'alignement du texte des versets.',
                alignLeft: 'Gauche',
                alignCenter: 'Centre',
                alignRight: 'Droite',
                settingTransition: 'Effet de transition',
                settingTransitionDesc: 'Animation utilis√©e pour afficher et masquer les versets.',
                transFade: 'Fondu',
                transSlideUp: 'Glisser haut',
                transSlideDown: 'Glisser bas',
                transSlideLeft: 'Glisser gauche',
                transZoom: 'Zoom',
                transNone: 'Aucun',
                settingAutoHide: 'Masquer automatiquement',
                settingAutoHideDesc: 'Masque automatiquement le verset apr√®s un d√©lai.',
                settingAutoHideDelay: 'D√©lai de masquage',
                settingAutoHideDelayDesc: 'Nombre de secondes avant disparition du verset.',
                settingTheme: 'Th√®me actuel',
                settingThemeDesc: 'Style visuel appliqu√© √† la source navigateur.',
                btnChange: 'Changer ‚Üí',
                // Nav bar
                navSearch: 'Recherche',
                navBible: 'Bible',
                navList: 'Liste',
                navTheme: 'Th√®me',
                navSettings: 'Param√®tres',
                // Toolbar titles
                titlePrevChapter: 'Chapitre pr√©c√©dent',
                titleNextChapter: 'Chapitre suivant',
                titlePrevVerse: 'Verset pr√©c√©dent (‚Üë)',
                titleNextVerse: 'Verset suivant (‚Üì)',
                titleAddFav: 'Ajouter aux favoris (+)',
                titleDeleteAll: 'Tout supprimer',
                // Dynamic messages
                noBookFound: 'Aucun livre trouv√©',
                noBibleFound: '-- Aucune Bible trouv√©e --',
                bookNotFound: 'Livre introuvable : ',
                chapterNotFound: 'Chapitre {ch} introuvable dans {book}',
                versesNotFound: 'Verset(s) introuvable(s) : ',
                invalidRef: 'Format invalide. Essayez : Gen√®se 1 ou Jean 3:16',
                noDataFor: 'Aucune donn√©e pour '
            },
            en: {
                searchTitle: 'Bible Query',
                labelBible: 'Bible:',
                labelReference: 'Reference:',
                placeholderBook: 'Type a book name...',
                btnSubmit: 'Submit',
                emptyVerses: 'No verses selected.',
                listTitle: 'Favorites',
                titleDeleteAll: 'Delete all',
                emptyFavorites: 'No favorites yet. Use the <strong>+</strong> button to add verses.',
                favRemove: 'Remove',
                themeTitle: 'Theme',
                themeDesc: 'Choose a theme for the Bible display (browser source).',
                settingsTitle: 'Settings',
                settingLanguage: 'Language',
                settingLanguageDesc: 'Interface language for the control panel.',
                settingRefFontSize: 'Reference Font Size',
                settingRefFontSizeDesc: 'Scales the font size of the verse reference display.',
                settingVerseFontSize: 'Verse Font Size',
                settingVerseFontSizeDesc: 'Scales the font size of displayed Bible verses.',
                settingLineSpacing: 'Line Spacing',
                settingLineSpacingDesc: 'Controls the line height of the verse text.',
                settingMaxLines: 'Maximum number of lines',
                settingMaxLinesDesc: 'Splits Bible verses into different slides if there are too many lines. Leave at 0 for no limit.',
                settingOpacity: 'Opacity',
                settingOpacityDesc: 'Controls the transparency of the verse display block.',
                settingAlignment: 'Text Alignment',
                settingAlignmentDesc: 'Sets the text alignment for the verse display.',
                alignLeft: 'Left',
                alignCenter: 'Center',
                alignRight: 'Right',
                settingTransition: 'Transition Effect',
                settingTransitionDesc: 'Animation used when displaying and hiding verses.',
                transFade: 'Fade',
                transSlideUp: 'Slide Up',
                transSlideDown: 'Slide Down',
                transSlideLeft: 'Slide Left',
                transZoom: 'Zoom',
                transNone: 'None',
                settingAutoHide: 'Auto-hide Verse',
                settingAutoHideDesc: 'Automatically hides the verse after a set duration.',
                settingAutoHideDelay: 'Auto-hide Delay',
                settingAutoHideDelayDesc: 'Number of seconds before the verse disappears.',
                settingTheme: 'Current Theme',
                settingThemeDesc: 'Visual style applied to the browser source display.',
                btnChange: 'Change ‚Üí',
                navSearch: 'Search',
                navBible: 'Bible',
                navList: 'List',
                navTheme: 'Theme',
                navSettings: 'Settings',
                titlePrevChapter: 'Previous chapter',
                titleNextChapter: 'Next chapter',
                titlePrevVerse: 'Previous verse (‚Üë)',
                titleNextVerse: 'Next verse (‚Üì)',
                titleAddFav: 'Add to favorites (+)',
                titleDeleteAll: 'Delete all',
                noBookFound: 'No book found',
                noBibleFound: '-- No Bible found --',
                bookNotFound: 'Book not found: ',
                chapterNotFound: 'Chapter {ch} not found in {book}',
                versesNotFound: 'Verse(s) not found: ',
                invalidRef: 'Invalid reference format. Try: Genesis 1 or John 3:16',
                noDataFor: 'No data found for '
            }
        };

        let currentLang = localStorage.getItem('bibleLanguage') || 'fr';

        function t(key, replacements) {
            let text = (i18n[currentLang] && i18n[currentLang][key]) || (i18n.en[key]) || key;
            if (replacements) {
                for (const [k, v] of Object.entries(replacements)) {
                    text = text.replace(`{${k}}`, v);
                }
            }
            return text;
        }

        function applyLanguage() {
            // Text content
            $('[data-i18n]').each(function() {
                const key = $(this).data('i18n');
                $(this).text(t(key));
            });
            // HTML content (for bold tags etc.)
            $('[data-i18n-html]').each(function() {
                const key = $(this).data('i18n-html');
                $(this).html(t(key));
            });
            // Placeholders
            $('[data-i18n-placeholder]').each(function() {
                const key = $(this).data('i18n-placeholder');
                $(this).attr('placeholder', t(key));
            });
            // Titles
            $('[data-i18n-title]').each(function() {
                const key = $(this).data('i18n-title');
                $(this).attr('title', t(key));
            });
            // Update html lang attribute
            $('html').attr('lang', currentLang);
        }

        // ====== State ======
        let selectedBook = null;
        let isLoading = false;

        // ====== Tab Navigation ======
        function switchTab(tabId) {
            $('.tab-content').hide();
            $('#' + tabId).show();
            $('.nav-btn').removeClass('active');
            $(`.nav-btn[data-tab="${tabId}"]`).addClass('active');
        }

        $('.nav-btn').click(function() {
            const tabId = $(this).data('tab');
            switchTab(tabId);
        });

        // ====== Bible Version Loader ======
        function initVersions() {
            console.log('Initializing Bible versions...');
            const versions = getAvailableVersions();
            const select = $('#bibleSelect');
            select.empty();

            if (versions.length === 0) {
                select.append('<option value="">' + t('noBibleFound') + '</option>');
                console.error('No Bible versions found. Check that JS files are loaded.');
                return;
            }

            versions.forEach((v, idx) => {
                select.append(`<option value="${idx}">${v.name}</option>`);
            });

            console.log(`Dropdown populated with ${versions.length} versions`);

            // Load the first version by default
            if (versions.length > 0) {
                loadBible(versions[0].key, versions[0].mappingKey);
                console.log('Default Bible loaded:', versions[0].name);
            }
        }

        // When Bible version changes, reload
        $('#bibleSelect').on('change', function() {
            const idx = parseInt($(this).val());
            if (availableVersions[idx]) {
                isLoading = true;
                $('#referenceInput').val('');
                hideAutocomplete();
                loadBible(availableVersions[idx].key, availableVersions[idx].mappingKey);
                isLoading = false;
            }
        });

        // ====== Autocomplete ======
        function showAutocomplete(items) {
            const list = $('#autocompleteList');
            list.empty();

            if (items.length === 0) {
                list.html('<div class="autocomplete-item no-results">' + t('noBookFound') + '</div>');
            } else {
                items.forEach(bookName => {
                    const item = $(`<div class="autocomplete-item">${bookName}</div>`);
                    item.on('mousedown', function(e) {
                        e.preventDefault(); // prevent blur
                        selectBook(bookName);
                    });
                    list.append(item);
                });
            }

            $('#autocompleteDropdown').addClass('show');
        }

        function hideAutocomplete() {
            $('#autocompleteDropdown').removeClass('show');
        }

        function selectBook(bookName) {
            selectedBook = bookName;
            $('#referenceInput').val(bookName + ' ');
            hideAutocomplete();
            // Focus back on input so user can type chapter
            $('#referenceInput').focus();
        }

        // ====== Reference Input Handler ======
        $('#referenceInput').on('input', function() {
            const input = $(this).val().trim();

            if (input.length === 0) {
                hideAutocomplete();
                selectedBook = null;
                return;
            }

            // Check if input contains a chapter number (book has been selected)
            const parsed = parseReference(input);
            if (parsed && findBook(parsed.book)) {
                // User is typing chapter/verse, hide autocomplete
                hideAutocomplete();
                return;
            }

            // Check if the input exactly matches a book (user selected from list)
            const exactBook = bibleBookNames.find(b => b.toLowerCase() === input.toLowerCase());
            if (exactBook) {
                selectedBook = exactBook;
                hideAutocomplete();
                return;
            }

            // Otherwise, show autocomplete suggestions
            const matches = searchBooks(input);
            showAutocomplete(matches);
        });

        $('#referenceInput').on('focus', function() {
            const input = $(this).val().trim();
            if (input.length > 0) {
                const parsed = parseReference(input);
                if (!parsed || !findBook(parsed.book)) {
                    const matches = searchBooks(input);
                    if (matches.length > 0) {
                        showAutocomplete(matches);
                    }
                }
            }
        });

        $('#referenceInput').on('blur', function() {
            setTimeout(() => hideAutocomplete(), 150);
        });

        // ====== Submit / Display ======
        function submitReference() {
            const reference = $('#referenceInput').val().trim();
            if (!reference) {
                return;
            }

            const parsed = parseReference(reference);

            if (parsed) {
                const bookKey = findBook(parsed.book);
                if (!bookKey) {
                    showBibleError(t('bookNotFound') + parsed.book);
                    return;
                }

                const localName = getLocalizedBookName(bookKey);

                if (parsed.verse === null) {
                    // Whole chapter: "Book Chapter"
                    const verses = getChapter(bookKey, parsed.chapter);
                    if (verses.length > 0) {
                        displayVerses(verses, `${localName} ${parsed.chapter}`, bookKey, parsed.chapter);
                    } else {
                        showBibleError(t('chapterNotFound', {ch: parsed.chapter, book: localName}));
                    }
                } else {
                    // Specific verse or range
                    const verses = getVersesByReference(reference);
                    if (verses) {
                        const rangeStr = parsed.verse === parsed.verseEnd
                            ? `${localName} ${parsed.chapter}:${parsed.verse}`
                            : `${localName} ${parsed.chapter}:${parsed.verse}-${parsed.verseEnd}`;
                        displayVerses(verses, rangeStr, bookKey, parsed.chapter);
                    } else {
                        showBibleError(t('versesNotFound') + reference);
                    }
                }
            } else {
                // Maybe just a book name? Show all chapters info
                const bookKey = findBook(reference);
                if (bookKey) {
                    const localName = getLocalizedBookName(bookKey);
                    // Default to chapter 1
                    const verses = getChapter(bookKey, '1');
                    if (verses.length > 0) {
                        displayVerses(verses, `${localName} 1`, bookKey, '1');
                    } else {
                        showBibleError(t('noDataFor') + localName);
                    }
                } else {
                    showBibleError(t('invalidRef'));
                }
            }
        }

        function displayVerses(verses, title, bookKeyParam, chapterParam) {
            const container = $('#versesContainer');
            container.empty();

            // Get the current Bible version name
            const idx = parseInt($('#bibleSelect').val());
            const versionName = availableVersions[idx] ? availableVersions[idx].name : '';
            const versionAbbr = availableVersions[idx] ? availableVersions[idx].key : '';

            $('#bibleTitle').text(`${title} (${versionAbbr})`);

            // Track context for chapter navigation
            if (bookKeyParam && chapterParam) {
                currentBibleContext = {
                    bookKey: bookKeyParam,
                    chapter: String(chapterParam),
                    totalChapters: getChapterCount(bookKeyParam)
                };
            } else {
                // Try to extract from first verse
                if (verses.length > 0 && verses[0].bookKey) {
                    currentBibleContext = {
                        bookKey: verses[0].bookKey,
                        chapter: verses[0].chapter,
                        totalChapters: getChapterCount(verses[0].bookKey)
                    };
                }
            }

            verses.forEach(v => {
                const verseEl = $(`
                    <div class="verse-item" data-ref="${v.reference || ''}" data-verse-text="${(v.text || '').replace(/"/g, '&quot;')}">
                        <span class="verse-num">${v.verse}</span>
                        <span class="verse-text">${v.text}</span>
                    </div>
                `);

                // Click to select/send verse
                verseEl.on('click', function() {
                    const wasSelected = $(this).hasClass('selected');
                    
                    if (wasSelected) {
                        // Deselect and clear browser-source
                        $(this).removeClass('selected');
                        $(this).find('.verse-chunks-nav').remove();
                        $(this).find('.verse-text').text(v.text);
                        localStorage.setItem('currentVerseReference', '');
                        localStorage.setItem('currentVerseText', '');
                        localStorage.setItem('currentVerseSource', '');
                    } else {
                        // Deselect previous
                        $('.verse-item').removeClass('selected');
                        $('.verse-chunks-nav').remove();
                        // Restore full text on previously selected items
                        $('.verse-item').each(function() {
                            const origText = $(this).data('fulltext');
                            if (origText) $(this).find('.verse-text').text(origText);
                        });

                        $(this).addClass('selected');

                        // Check max lines and split if needed
                        const maxLines = parseInt(localStorage.getItem('bibleMaxLines') || '0');
                        if (maxLines > 0) {
                            const chunks = splitTextIntoChunks(v.text, maxLines);
                            if (chunks.length > 1) {
                                // Store data for navigation
                                $(this).data('fulltext', v.text);
                                $(this).data('chunks', chunks);
                                $(this).data('chunk-index', 0);
                                $(this).data('chunk-ref', v.reference || title);
                                $(this).data('chunk-version', versionName);

                                // Show chunk 1 with nav
                                showVerseChunk($(this), 0);
                                return;
                            }
                        }
                        
                        // Normal (no chunking needed)
                        localStorage.setItem('currentVerseReference', v.reference || `${title}`);
                        localStorage.setItem('currentVerseText', v.text);
                        localStorage.setItem('currentVerseSource', versionName);
                    }
                });

                container.append(verseEl);
            });

            // Switch to Bible tab
            switchTab('tabBible');
        }

        // Split text into chunks that approximate the max line count
        function splitTextIntoChunks(text, maxLines) {
            // Estimate ~60 chars per line as a rough average for the browser-source display
            const charsPerLine = 55;
            const chunkSize = maxLines * charsPerLine;
            
            if (text.length <= chunkSize) return [text];
            
            const chunks = [];
            let remaining = text;
            
            while (remaining.length > 0) {
                if (remaining.length <= chunkSize) {
                    chunks.push(remaining.trim());
                    break;
                }
                
                // Find a good break point (space, comma, semicolon) near the chunk size
                let breakAt = chunkSize;
                // Search backward for a space to avoid cutting words
                while (breakAt > chunkSize * 0.7 && remaining[breakAt] !== ' ') {
                    breakAt--;
                }
                if (breakAt <= chunkSize * 0.7) breakAt = chunkSize; // fallback
                
                chunks.push(remaining.substring(0, breakAt).trim());
                remaining = remaining.substring(breakAt).trim();
            }
            
            return chunks;
        }

        // Show a specific chunk of a verse
        function showVerseChunk(verseEl, chunkIdx) {
            const chunks = verseEl.data('chunks');
            const ref = verseEl.data('chunk-ref');
            const versionName = verseEl.data('chunk-version');
            
            chunkIdx = Math.max(0, Math.min(chunks.length - 1, chunkIdx));
            verseEl.data('chunk-index', chunkIdx);

            // Update text display in control panel
            const displayText = chunks[chunkIdx] + (chunkIdx < chunks.length - 1 ? ' ...' : '');
            verseEl.find('.verse-text').html(
                `<span class="chunk-text">${displayText}</span>`
            );

            // Remove old nav, add new
            verseEl.find('.verse-chunks-nav').remove();
            const nav = $(`
                <div class="verse-chunks-nav">
                    <button class="chunk-btn chunk-prev" ${chunkIdx === 0 ? 'disabled' : ''}>‚óÄ</button>
                    <span class="chunk-indicator">${chunkIdx + 1} / ${chunks.length}</span>
                    <button class="chunk-btn chunk-next" ${chunkIdx === chunks.length - 1 ? 'disabled' : ''}>‚ñ∂</button>
                </div>
            `);

            nav.find('.chunk-prev').on('click', function(e) {
                e.stopPropagation();
                showVerseChunk(verseEl, chunkIdx - 1);
            });

            nav.find('.chunk-next').on('click', function(e) {
                e.stopPropagation();
                showVerseChunk(verseEl, chunkIdx + 1);
            });

            verseEl.append(nav);

            // Send chunk to browser-source
            const suffix = chunks.length > 1 ? ` (${chunkIdx + 1}/${chunks.length})` : '';
            localStorage.setItem('currentVerseReference', ref + suffix);
            localStorage.setItem('currentVerseText', chunks[chunkIdx]);
            localStorage.setItem('currentVerseSource', versionName);
        }

        function showBibleError(msg) {
            const container = $('#versesContainer');
            container.html(`<div class="bible-error"><p>‚ö†Ô∏è ${msg}</p></div>`);
            switchTab('tabBible');
        }

        // Submit button
        $('#displayBtn').click(function() {
            submitReference();
        });

        // Enter key
        $('#referenceInput').keypress(function(e) {
            if (e.which === 13) {
                hideAutocomplete();
                submitReference();
            }
        });

        // Back button in Bible tab
        $('#bibleBackBtn').click(function() {
            switchTab('tabSearch');
        });

        // ====== Init ======
        $(document).ready(function() {
            initVersions();
            loadSettings();
        });

        // ====== Theme Selection ======
        $('.theme-card').click(function() {
            const theme = $(this).data('theme');
            $('.theme-card').removeClass('selected');
            $(this).addClass('selected');
            localStorage.setItem('bibleTheme', theme);
            $('#currentThemeName').text($(this).find('.theme-name').text());
        });

        // Highlight currently saved theme on load
        function loadSettings() {
            // Language
            currentLang = localStorage.getItem('bibleLanguage') || 'fr';
            $('#languageSelect').val(currentLang);
            applyLanguage();

            const savedTheme = localStorage.getItem('bibleTheme') || 'classic-dark';
            $(`.theme-card[data-theme="${savedTheme}"]`).addClass('selected');
            $('#currentThemeName').text($(`.theme-card[data-theme="${savedTheme}"] .theme-name`).text() || 'Classic Dark');

            $('#refFontSizeInput').val(localStorage.getItem('bibleRefFontSize') || '20');
            $('#verseFontSizeInput').val(localStorage.getItem('bibleVerseFontSize') || '18');
            $('#lineHeightInput').val(localStorage.getItem('bibleLineHeight') || '1.6');
            $('#maxLinesInput').val(localStorage.getItem('bibleMaxLines') || '0');
            $('#opacityInput').val(localStorage.getItem('bibleOpacity') || '100');
            $('#alignmentSelect').val(localStorage.getItem('bibleAlignment') || 'center');
            $('#transitionSelect').val(localStorage.getItem('bibleTransition') || 'fade');

            const savedAutoHide = localStorage.getItem('bibleAutoHide') === 'true';
            $('#autoHideToggle').prop('checked', savedAutoHide);
            $('#autoHideTimerSection').toggle(savedAutoHide);
            $('#timerInput').val(localStorage.getItem('bibleAutoHideTimer') || '5');
        }

        // ====== Settings: Spin controls ======
        function bindSpinControl(inputId, upId, downId, storageKey, step, min, max, isFloat) {
            const $input = $(`#${inputId}`);

            function save() {
                let val = isFloat ? parseFloat($input.val()) : parseInt($input.val());
                val = Math.max(min, Math.min(max, isNaN(val) ? min : val));
                $input.val(isFloat ? val.toFixed(1) : val);
                localStorage.setItem(storageKey, isFloat ? val.toFixed(1) : val.toString());
            }

            $input.on('change', save);

            $(`#${upId}`).click(function() {
                let val = isFloat ? parseFloat($input.val()) : parseInt($input.val());
                val = Math.min(max, val + step);
                $input.val(isFloat ? val.toFixed(1) : val);
                save();
            });

            $(`#${downId}`).click(function() {
                let val = isFloat ? parseFloat($input.val()) : parseInt($input.val());
                val = Math.max(min, val - step);
                $input.val(isFloat ? val.toFixed(1) : val);
                save();
            });
        }

        bindSpinControl('refFontSizeInput', 'refFontIncrease', 'refFontDecrease', 'bibleRefFontSize', 1, 10, 48, false);
        bindSpinControl('verseFontSizeInput', 'verseFontIncrease', 'verseFontDecrease', 'bibleVerseFontSize', 1, 10, 48, false);
        bindSpinControl('lineHeightInput', 'lineHeightIncrease', 'lineHeightDecrease', 'bibleLineHeight', 0.1, 1.0, 3.0, true);
        bindSpinControl('maxLinesInput', 'maxLinesIncrease', 'maxLinesDecrease', 'bibleMaxLines', 1, 0, 10, false);
        bindSpinControl('opacityInput', 'opacityIncrease', 'opacityDecrease', 'bibleOpacity', 5, 10, 100, false);
        bindSpinControl('timerInput', 'timerIncrease', 'timerDecrease', 'bibleAutoHideTimer', 1, 2, 20, false);

        // ====== Settings: Select controls ======
        $('#alignmentSelect').on('change', function() {
            localStorage.setItem('bibleAlignment', $(this).val());
        });

        $('#transitionSelect').on('change', function() {
            localStorage.setItem('bibleTransition', $(this).val());
        });

        // ====== Settings: Language ======
        $('#languageSelect').on('change', function() {
            currentLang = $(this).val();
            localStorage.setItem('bibleLanguage', currentLang);
            applyLanguage();
        });

        // ====== Settings: Auto-hide ======
        $('#autoHideToggle').change(function() {
            const enabled = $(this).is(':checked');
            localStorage.setItem('bibleAutoHide', enabled.toString());
            $('#autoHideTimerSection').toggle(enabled);
        });

        // ====== Settings: Go to themes ======
        $('#goToThemes').click(function() {
            switchTab('tabTheme');
        });

        // ====== Arrow Key Navigation ======
        let currentBibleContext = null; // { bookKey, chapter, totalChapters }

        function selectVerseByDirection(direction) {
            const verses = $('.verse-item');
            if (verses.length === 0) return;

            const currentSelected = $('.verse-item.selected');
            let targetIndex;

            if (currentSelected.length === 0) {
                // Nothing selected: pick first (down) or last (up)
                targetIndex = direction === 'down' ? 0 : verses.length - 1;
            } else {
                const currentIndex = verses.index(currentSelected);
                targetIndex = direction === 'down' ? currentIndex + 1 : currentIndex - 1;
            }

            if (targetIndex < 0 || targetIndex >= verses.length) return;

            // Simulate click on the target verse
            $(verses[targetIndex]).trigger('click');

            // Scroll into view
            const targetEl = verses[targetIndex];
            targetEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Keyboard handler
        $(document).on('keydown', function(e) {
            // Only handle when Bible tab is visible and input is not focused
            if ($('#tabBible').is(':hidden')) return;
            if ($('input, select, textarea').is(':focus')) return;

            if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectVerseByDirection('up');
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectVerseByDirection('down');
            } else if (e.key === 'ArrowLeft') {
                e.preventDefault();
                navigateChapter(-1);
            } else if (e.key === 'ArrowRight') {
                e.preventDefault();
                navigateChapter(1);
            } else if (e.key === '+' || e.key === '=') {
                e.preventDefault();
                addToFavorites();
            }
        });

        // Toolbar verse arrows
        $('#btnPrevVerse').click(function() {
            selectVerseByDirection('up');
        });
        $('#btnNextVerse').click(function() {
            selectVerseByDirection('down');
        });

        // ====== Chapter Navigation ======
        function navigateChapter(delta) {
            if (!currentBibleContext) return;
            const newChapter = parseInt(currentBibleContext.chapter) + delta;
            if (newChapter < 1 || newChapter > currentBibleContext.totalChapters) return;

            const bookKey = currentBibleContext.bookKey;
            const localName = getLocalizedBookName(bookKey);
            const verses = getChapter(bookKey, String(newChapter));
            if (verses.length > 0) {
                displayVerses(verses, `${localName} ${newChapter}`, bookKey, newChapter);
                // Update context
                currentBibleContext.chapter = String(newChapter);
            }
        }

        $('#btnPrevChapter').click(function() {
            navigateChapter(-1);
        });
        $('#btnNextChapter').click(function() {
            navigateChapter(1);
        });

        // ====== Favorites / List ======
        function getFavorites() {
            try {
                return JSON.parse(sessionStorage.getItem('bibleFavorites') || '[]');
            } catch(e) {
                return [];
            }
        }

        function saveFavorites(favs) {
            sessionStorage.setItem('bibleFavorites', JSON.stringify(favs));
            renderFavorites();
        }

        function addToFavorites() {
            const selected = $('.verse-item.selected');
            if (selected.length === 0) return;

            const ref = selected.data('ref');
            const text = selected.data('fulltext') || selected.attr('data-verse-text') || selected.find('.verse-text').text();
            const idx = parseInt($('#bibleSelect').val());
            const versionName = availableVersions[idx] ? availableVersions[idx].name : '';

            if (!ref) return;

            const favs = getFavorites();
            // Avoid duplicates
            if (favs.some(f => f.reference === ref && f.version === versionName)) return;

            favs.push({
                reference: ref,
                text: text,
                version: versionName,
                timestamp: Date.now()
            });

            saveFavorites(favs);

            // Visual feedback
            const btn = $('#btnAddToList');
            btn.addClass('toolbar-btn-flash');
            setTimeout(() => btn.removeClass('toolbar-btn-flash'), 400);
        }

        function renderFavorites() {
            const favs = getFavorites();
            const container = $('#favoritesContainer');
            container.empty();

            if (favs.length === 0) {
                container.html('<p class="empty-msg">' + t('emptyFavorites') + '</p>');
                return;
            }

            favs.forEach((fav, idx) => {
                const shortText = fav.text.length > 120 ? fav.text.substring(0, 120) + '...' : fav.text;
                const item = $(`
                    <div class="fav-item" data-index="${idx}">
                        <div class="fav-content">
                            <div class="fav-ref">${fav.reference} <span class="fav-version">(${fav.version})</span></div>
                            <div class="fav-text">${shortText}</div>
                        </div>
                        <button class="fav-remove" title="${t('favRemove')}">‚úï</button>
                    </div>
                `);

                // Click to send to browser source
                item.find('.fav-content').on('click', function() {
                    $('.fav-item').removeClass('fav-active');
                    item.addClass('fav-active');
                    localStorage.setItem('currentVerseReference', fav.reference);
                    localStorage.setItem('currentVerseText', fav.text);
                    localStorage.setItem('currentVerseSource', fav.version);
                });

                // Remove button
                item.find('.fav-remove').on('click', function(e) {
                    e.stopPropagation();
                    const favs = getFavorites();
                    favs.splice(idx, 1);
                    saveFavorites(favs);
                });

                container.append(item);
            });
        }

        // + button in toolbar
        $('#btnAddToList').click(function() {
            addToFavorites();
        });

        // Clear all favorites
        $('#btnClearList').click(function() {
            if (getFavorites().length === 0) return;
            saveFavorites([]);
        });

        // Render favorites on tab switch
        $(`.nav-btn[data-tab="tabList"]`).click(function() {
            renderFavorites();
        });
    </script>
</body>
</html>