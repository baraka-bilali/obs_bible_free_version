<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBS Bible Free Version - Control Panel</title>
    <link rel="stylesheet" href="../common/css/style-control_panel.css">
    <link rel="stylesheet" href="../common/css/cp-icons.css">
    <link rel="stylesheet" href="../common/css/themes/dark/theme.css">
    <script src="../common/js/jquery.js"></script>
    <script src="../common/js/jscolor.js"></script>
    <!-- Bible data (pre-generated JS files, works with file:// protocol) -->
    <script src="../bible-versions/js/versions-index.js"></script>
    <script src="../bible-versions/js/book_name_mapping.js"></script>
    <script src="../bible-versions/js/LSG.js"></script>
    <script src="../bible-versions/js/KJV.js"></script>
    <script src="../bible-versions/js/WEB.js"></script>
    <script src="../common/js/bible-api.js"></script>
</head>
<body>
    <!-- ===== SEARCH TAB (main view) ===== -->
    <div class="tab-content" id="tabSearch">
        <div class="container">
            <div class="main-panel">
                <h1>Bible Query</h1>

                <!-- Bible Selection -->
                <div class="form-group">
                    <label for="bibleSelect">Bible:</label>
                    <select id="bibleSelect" class="form-control">
                        <!-- Options populated dynamically -->
                    </select>
                </div>

                <!-- Reference Input with Autocomplete -->
                <div class="form-group">
                    <label for="referenceInput">Reference:</label>
                    <div class="reference-input-wrapper">
                        <input type="text" id="referenceInput" class="form-control" 
                               placeholder="Type a book name..." autocomplete="off">
                    </div>
                </div>

                <!-- Autocomplete Dropdown -->
                <div id="autocompleteDropdown" class="autocomplete-dropdown">
                    <div id="autocompleteList" class="autocomplete-list">
                        <!-- Items populated dynamically -->
                    </div>
                </div>

                <!-- Submit Button -->
                <button id="displayBtn" class="btn btn-primary">Submit</button>
            </div>
        </div>
    </div>

    <!-- ===== BIBLE TAB ===== -->
    <div class="tab-content" id="tabBible" style="display:none;">
        <div class="container bible-container">
            <div class="main-panel bible-panel">
                <div class="bible-header">
                    <button id="bibleBackBtn" class="btn-back" title="Retour">&#8592;</button>
                    <h2 id="bibleTitle">Bible</h2>
                </div>
                <div id="versesContainer" class="verses-container">
                    <!-- Verses displayed here -->
                    <p class="empty-msg">No verses selected.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== LIST TAB ===== -->
    <div class="tab-content" id="tabList" style="display:none;">
        <div class="container">
            <div class="main-panel">
                <h1>List</h1>
                <p style="color:#888;text-align:center;padding:40px 0;">Coming soon...</p>
            </div>
        </div>
    </div>

    <!-- ===== THEME TAB ===== -->
    <div class="tab-content" id="tabTheme" style="display:none;">
        <div class="container">
            <div class="main-panel">
                <h1>Theme</h1>
                <p class="section-desc">Choose a theme for the Bible display (browser source).</p>
                <div class="theme-grid">
                    <div class="theme-card" data-theme="classic-dark">
                        <div class="theme-preview" style="background:linear-gradient(135deg,#1e1e32,#2d2d46);border-top:3px solid #0a84ff;">
                            <span style="color:#0a84ff;font-size:10px;font-weight:700;">JEAN 3:16</span>
                            <span style="color:#e8e8e8;font-size:9px;">Car Dieu a tant aim√©...</span>
                        </div>
                        <span class="theme-name">Classic Dark</span>
                    </div>
                    <div class="theme-card" data-theme="royal-purple">
                        <div class="theme-preview" style="background:linear-gradient(135deg,#30104a,#481c6e);border-top:3px solid #b44dff;">
                            <span style="color:#d89eff;font-size:10px;font-weight:700;">JEAN 3:16</span>
                            <span style="color:#f0e6ff;font-size:9px;">Car Dieu a tant aim√©...</span>
                        </div>
                        <span class="theme-name">Royal Purple</span>
                    </div>
                    <div class="theme-card" data-theme="warm-gold">
                        <div class="theme-preview" style="background:linear-gradient(135deg,#32230a,#4b3714);border-top:3px solid #d4a017;">
                            <span style="color:#f5c842;font-size:10px;font-weight:700;">JEAN 3:16</span>
                            <span style="color:#faebd7;font-size:9px;">Car Dieu a tant aim√©...</span>
                        </div>
                        <span class="theme-name">Warm Gold</span>
                    </div>
                    <div class="theme-card" data-theme="ocean-blue">
                        <div class="theme-preview" style="background:linear-gradient(135deg,#0a1e3c,#0f325a);border-top:3px solid #00b4d8;">
                            <span style="color:#48cae4;font-size:10px;font-weight:700;">JEAN 3:16</span>
                            <span style="color:#caf0f8;font-size:9px;">Car Dieu a tant aim√©...</span>
                        </div>
                        <span class="theme-name">Ocean Blue</span>
                    </div>
                    <div class="theme-card" data-theme="clean-white">
                        <div class="theme-preview" style="background:linear-gradient(135deg,#f5f5f5,#ffffff);border-top:3px solid #333;">
                            <span style="color:#222;font-size:10px;font-weight:700;">JEAN 3:16</span>
                            <span style="color:#333;font-size:9px;">Car Dieu a tant aim√©...</span>
                        </div>
                        <span class="theme-name">Clean White</span>
                    </div>
                    <div class="theme-card" data-theme="forest-green">
                        <div class="theme-preview" style="background:linear-gradient(135deg,#0f2819,#193c23);border-top:3px solid #2ecc71;">
                            <span style="color:#55efc4;font-size:10px;font-weight:700;">JEAN 3:16</span>
                            <span style="color:#d4efdf;font-size:9px;">Car Dieu a tant aim√©...</span>
                        </div>
                        <span class="theme-name">Forest Green</span>
                    </div>
                    <div class="theme-card" data-theme="crimson">
                        <div class="theme-preview" style="background:linear-gradient(135deg,#370a0f,#551419);border-top:3px solid #e74c3c;">
                            <span style="color:#ff7675;font-size:10px;font-weight:700;">JEAN 3:16</span>
                            <span style="color:#fce4e4;font-size:9px;">Car Dieu a tant aim√©...</span>
                        </div>
                        <span class="theme-name">Crimson</span>
                    </div>
                    <div class="theme-card" data-theme="transparent">
                        <div class="theme-preview" style="background:rgba(0,0,0,0.55);border-top:none;">
                            <span style="color:#fff;font-size:10px;font-weight:700;">JEAN 3:16</span>
                            <span style="color:#f0f0f0;font-size:9px;">Car Dieu a tant aim√©...</span>
                        </div>
                        <span class="theme-name">Transparent</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== SETTINGS TAB ===== -->
    <div class="tab-content" id="tabSettings" style="display:none;">
        <div class="container">
            <div class="main-panel">
                <h1>Settings</h1>

                <!-- Reference Font Size -->
                <div class="settings-section">
                    <label>Reference Font Size</label>
                    <div class="font-size-control">
                        <button id="refFontDecrease" class="btn-setting" title="R√©duire">A‚àí</button>
                        <span id="refFontSizeValue" class="font-size-value">20px</span>
                        <button id="refFontIncrease" class="btn-setting" title="Agrandir">A+</button>
                    </div>
                    <input type="range" id="refFontSizeSlider" class="setting-slider" min="10" max="48" value="20">
                </div>

                <!-- Verse Font Size -->
                <div class="settings-section">
                    <label>Verse Font Size</label>
                    <div class="font-size-control">
                        <button id="verseFontDecrease" class="btn-setting" title="R√©duire">A‚àí</button>
                        <span id="verseFontSizeValue" class="font-size-value">18px</span>
                        <button id="verseFontIncrease" class="btn-setting" title="Agrandir">A+</button>
                    </div>
                    <input type="range" id="verseFontSizeSlider" class="setting-slider" min="10" max="48" value="18">
                </div>

                <!-- Line Spacing -->
                <div class="settings-section">
                    <label>Line Spacing</label>
                    <div class="font-size-control">
                        <button id="lineHeightDecrease" class="btn-setting" title="R√©duire">‚àí</button>
                        <span id="lineHeightValue" class="font-size-value">1.6</span>
                        <button id="lineHeightIncrease" class="btn-setting" title="Agrandir">+</button>
                    </div>
                    <input type="range" id="lineHeightSlider" class="setting-slider" min="10" max="30" value="16" step="1">
                </div>

                <!-- Text Alignment -->
                <div class="settings-section">
                    <label>Alignment</label>
                    <div class="alignment-control">
                        <button class="btn-align active" data-align="left" title="Gauche">‚¨õ‚óª‚óª</button>
                        <button class="btn-align" data-align="center" title="Centre">‚óª‚¨õ‚óª</button>
                        <button class="btn-align" data-align="right" title="Droite">‚óª‚óª‚¨õ</button>
                    </div>
                </div>

                <!-- Current Theme Preview -->
                <div class="settings-section">
                    <label>Current Theme</label>
                    <div class="current-theme-info">
                        <span id="currentThemeName">Classic Dark</span>
                        <button id="goToThemes" class="btn-link">Change ‚Üí</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation Bar -->
    <div class="bottom-nav">
        <button class="nav-btn active" data-tab="tabSearch" title="Rechercher">
            <span class="icon">üîç</span>
            <span class="label">Search</span>
        </button>
        <button class="nav-btn" data-tab="tabBible" title="Bible">
            <span class="icon">üìñ</span>
            <span class="label">Bible</span>
        </button>
        <button class="nav-btn" data-tab="tabList" title="Liste">
            <span class="icon">‚ò∞</span>
            <span class="label">List</span>
        </button>
        <button class="nav-btn" data-tab="tabTheme" title="Th√®me">
            <span class="icon">üé®</span>
            <span class="label">Theme</span>
        </button>
        <button class="nav-btn" data-tab="tabSettings" title="Param√®tres">
            <span class="icon">‚öôÔ∏è</span>
            <span class="label">Settings</span>
        </button>
    </div>

    <script>
        // ====== State ======
        let selectedBook = null;
        let isLoading = false;

        // ====== Tab Navigation ======
        function switchTab(tabId) {
            $('.tab-content').hide();
            $('#' + tabId).show();
            $('.nav-btn').removeClass('active');
            $(`.nav-btn[data-tab="${tabId}"]`).addClass('active');
        }

        $('.nav-btn').click(function() {
            const tabId = $(this).data('tab');
            switchTab(tabId);
        });

        // ====== Bible Version Loader ======
        function initVersions() {
            console.log('Initializing Bible versions...');
            const versions = getAvailableVersions();
            const select = $('#bibleSelect');
            select.empty();

            if (versions.length === 0) {
                select.append('<option value="">-- No Bible found --</option>');
                console.error('No Bible versions found. Check that JS files are loaded.');
                return;
            }

            versions.forEach((v, idx) => {
                select.append(`<option value="${idx}">${v.name}</option>`);
            });

            console.log(`Dropdown populated with ${versions.length} versions`);

            // Load the first version by default
            if (versions.length > 0) {
                loadBible(versions[0].key, versions[0].mappingKey);
                console.log('Default Bible loaded:', versions[0].name);
            }
        }

        // When Bible version changes, reload
        $('#bibleSelect').on('change', function() {
            const idx = parseInt($(this).val());
            if (availableVersions[idx]) {
                isLoading = true;
                $('#referenceInput').val('');
                hideAutocomplete();
                loadBible(availableVersions[idx].key, availableVersions[idx].mappingKey);
                isLoading = false;
            }
        });

        // ====== Autocomplete ======
        function showAutocomplete(items) {
            const list = $('#autocompleteList');
            list.empty();

            if (items.length === 0) {
                list.html('<div class="autocomplete-item no-results">No book found</div>');
            } else {
                items.forEach(bookName => {
                    const item = $(`<div class="autocomplete-item">${bookName}</div>`);
                    item.on('mousedown', function(e) {
                        e.preventDefault(); // prevent blur
                        selectBook(bookName);
                    });
                    list.append(item);
                });
            }

            $('#autocompleteDropdown').addClass('show');
        }

        function hideAutocomplete() {
            $('#autocompleteDropdown').removeClass('show');
        }

        function selectBook(bookName) {
            selectedBook = bookName;
            $('#referenceInput').val(bookName + ' ');
            hideAutocomplete();
            // Focus back on input so user can type chapter
            $('#referenceInput').focus();
        }

        // ====== Reference Input Handler ======
        $('#referenceInput').on('input', function() {
            const input = $(this).val().trim();

            if (input.length === 0) {
                hideAutocomplete();
                selectedBook = null;
                return;
            }

            // Check if input contains a chapter number (book has been selected)
            const parsed = parseReference(input);
            if (parsed && findBook(parsed.book)) {
                // User is typing chapter/verse, hide autocomplete
                hideAutocomplete();
                return;
            }

            // Check if the input exactly matches a book (user selected from list)
            const exactBook = bibleBookNames.find(b => b.toLowerCase() === input.toLowerCase());
            if (exactBook) {
                selectedBook = exactBook;
                hideAutocomplete();
                return;
            }

            // Otherwise, show autocomplete suggestions
            const matches = searchBooks(input);
            showAutocomplete(matches);
        });

        $('#referenceInput').on('focus', function() {
            const input = $(this).val().trim();
            if (input.length > 0) {
                const parsed = parseReference(input);
                if (!parsed || !findBook(parsed.book)) {
                    const matches = searchBooks(input);
                    if (matches.length > 0) {
                        showAutocomplete(matches);
                    }
                }
            }
        });

        $('#referenceInput').on('blur', function() {
            setTimeout(() => hideAutocomplete(), 150);
        });

        // ====== Submit / Display ======
        function submitReference() {
            const reference = $('#referenceInput').val().trim();
            if (!reference) {
                return;
            }

            const parsed = parseReference(reference);

            if (parsed) {
                const bookKey = findBook(parsed.book);
                if (!bookKey) {
                    showBibleError('Book not found: ' + parsed.book);
                    return;
                }

                const localName = getLocalizedBookName(bookKey);

                if (parsed.verse === null) {
                    // Whole chapter: "Book Chapter"
                    const verses = getChapter(bookKey, parsed.chapter);
                    if (verses.length > 0) {
                        displayVerses(verses, `${localName} ${parsed.chapter}`);
                    } else {
                        showBibleError(`Chapter ${parsed.chapter} not found in ${localName}`);
                    }
                } else {
                    // Specific verse or range
                    const verses = getVersesByReference(reference);
                    if (verses) {
                        const rangeStr = parsed.verse === parsed.verseEnd
                            ? `${localName} ${parsed.chapter}:${parsed.verse}`
                            : `${localName} ${parsed.chapter}:${parsed.verse}-${parsed.verseEnd}`;
                        displayVerses(verses, rangeStr);
                    } else {
                        showBibleError(`Verse(s) not found: ${reference}`);
                    }
                }
            } else {
                // Maybe just a book name? Show all chapters info
                const bookKey = findBook(reference);
                if (bookKey) {
                    const localName = getLocalizedBookName(bookKey);
                    // Default to chapter 1
                    const verses = getChapter(bookKey, '1');
                    if (verses.length > 0) {
                        displayVerses(verses, `${localName} 1`);
                    } else {
                        showBibleError(`No data found for ${localName}`);
                    }
                } else {
                    showBibleError('Invalid reference format. Try: Gen√®se 1 or Jean 3:16');
                }
            }
        }

        function displayVerses(verses, title) {
            const container = $('#versesContainer');
            container.empty();

            // Get the current Bible version name
            const idx = parseInt($('#bibleSelect').val());
            const versionName = availableVersions[idx] ? availableVersions[idx].name : '';

            $('#bibleTitle').text(title);

            verses.forEach(v => {
                const verseEl = $(`
                    <div class="verse-item" data-ref="${v.reference || ''}">
                        <span class="verse-num">${v.verse}</span>
                        <span class="verse-text">${v.text}</span>
                    </div>
                `);

                // Click to select/send verse
                verseEl.on('click', function() {
                    $('.verse-item').removeClass('selected');
                    $(this).addClass('selected');

                    // Save to localStorage for browser-source
                    localStorage.setItem('currentVerseReference', v.reference || `${title}`);
                    localStorage.setItem('currentVerseText', v.text);
                    localStorage.setItem('currentVerseSource', versionName);
                });

                container.append(verseEl);
            });

            // Switch to Bible tab
            switchTab('tabBible');
        }

        function showBibleError(msg) {
            const container = $('#versesContainer');
            container.html(`<div class="bible-error"><p>‚ö†Ô∏è ${msg}</p></div>`);
            switchTab('tabBible');
        }

        // Submit button
        $('#displayBtn').click(function() {
            submitReference();
        });

        // Enter key
        $('#referenceInput').keypress(function(e) {
            if (e.which === 13) {
                hideAutocomplete();
                submitReference();
            }
        });

        // Back button in Bible tab
        $('#bibleBackBtn').click(function() {
            switchTab('tabSearch');
        });

        // ====== Init ======
        $(document).ready(function() {
            initVersions();
            loadSettings();
        });

        // ====== Theme Selection ======
        $('.theme-card').click(function() {
            const theme = $(this).data('theme');
            $('.theme-card').removeClass('selected');
            $(this).addClass('selected');
            localStorage.setItem('bibleTheme', theme);
            $('#currentThemeName').text($(this).find('.theme-name').text());
        });

        // Highlight currently saved theme on load
        function loadSettings() {
            const savedTheme = localStorage.getItem('bibleTheme') || 'classic-dark';
            $(`.theme-card[data-theme="${savedTheme}"]`).addClass('selected');
            $('#currentThemeName').text($(`.theme-card[data-theme="${savedTheme}"] .theme-name`).text() || 'Classic Dark');

            const savedRefSize = localStorage.getItem('bibleRefFontSize') || '20';
            $('#refFontSizeSlider').val(savedRefSize);
            $('#refFontSizeValue').text(savedRefSize + 'px');

            const savedVerseSize = localStorage.getItem('bibleVerseFontSize') || '18';
            $('#verseFontSizeSlider').val(savedVerseSize);
            $('#verseFontSizeValue').text(savedVerseSize + 'px');

            const savedLineHeight = localStorage.getItem('bibleLineHeight') || '1.6';
            const sliderVal = Math.round(parseFloat(savedLineHeight) * 10);
            $('#lineHeightSlider').val(sliderVal);
            $('#lineHeightValue').text(savedLineHeight);

            const savedAlign = localStorage.getItem('bibleAlignment') || 'center';
            $('.btn-align').removeClass('active');
            $(`.btn-align[data-align="${savedAlign}"]`).addClass('active');
        }

        // ====== Settings: Reference Font Size ======
        function updateRefFontSize(size) {
            size = Math.max(10, Math.min(48, parseInt(size)));
            $('#refFontSizeSlider').val(size);
            $('#refFontSizeValue').text(size + 'px');
            localStorage.setItem('bibleRefFontSize', size.toString());
        }

        $('#refFontSizeSlider').on('input', function() {
            updateRefFontSize($(this).val());
        });

        $('#refFontIncrease').click(function() {
            const current = parseInt($('#refFontSizeSlider').val());
            updateRefFontSize(current + 2);
        });

        $('#refFontDecrease').click(function() {
            const current = parseInt($('#refFontSizeSlider').val());
            updateRefFontSize(current - 2);
        });

        // ====== Settings: Verse Font Size ======
        function updateVerseFontSize(size) {
            size = Math.max(10, Math.min(48, parseInt(size)));
            $('#verseFontSizeSlider').val(size);
            $('#verseFontSizeValue').text(size + 'px');
            localStorage.setItem('bibleVerseFontSize', size.toString());
        }

        $('#verseFontSizeSlider').on('input', function() {
            updateVerseFontSize($(this).val());
        });

        $('#verseFontIncrease').click(function() {
            const current = parseInt($('#verseFontSizeSlider').val());
            updateVerseFontSize(current + 2);
        });

        $('#verseFontDecrease').click(function() {
            const current = parseInt($('#verseFontSizeSlider').val());
            updateVerseFontSize(current - 2);
        });

        // ====== Settings: Line Spacing ======
        function updateLineHeight(sliderVal) {
            sliderVal = Math.max(10, Math.min(30, parseInt(sliderVal)));
            const lineHeight = (sliderVal / 10).toFixed(1);
            $('#lineHeightSlider').val(sliderVal);
            $('#lineHeightValue').text(lineHeight);
            localStorage.setItem('bibleLineHeight', lineHeight);
        }

        $('#lineHeightSlider').on('input', function() {
            updateLineHeight($(this).val());
        });

        $('#lineHeightIncrease').click(function() {
            const current = parseInt($('#lineHeightSlider').val());
            updateLineHeight(current + 2);
        });

        $('#lineHeightDecrease').click(function() {
            const current = parseInt($('#lineHeightSlider').val());
            updateLineHeight(current - 2);
        });

        // ====== Settings: Alignment ======
        $('.btn-align').click(function() {
            const align = $(this).data('align');
            $('.btn-align').removeClass('active');
            $(this).addClass('active');
            localStorage.setItem('bibleAlignment', align);
        });

        // ====== Settings: Go to themes ======
        $('#goToThemes').click(function() {
            switchTab('tabTheme');
        });
    </script>
</body>
</html>
