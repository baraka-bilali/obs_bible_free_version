<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBS Bible Free Version - Control Panel</title>
    <link rel="stylesheet" href="../common/css/style-control_panel.css">
    <link rel="stylesheet" href="../common/css/cp-icons.css">
    <link rel="stylesheet" href="../common/css/themes/dark/theme.css">
    <script src="../common/js/jquery.js"></script>
    <script src="../common/js/jscolor.js"></script>
    <!-- Bible data (pre-generated JS files, works with file:// protocol) -->
    <script src="../bible-versions/js/versions-index.js"></script>
    <script src="../bible-versions/js/book_name_mapping.js"></script>
    <script src="../bible-versions/js/LSG.js"></script>
    <script src="../bible-versions/js/KJV.js"></script>
    <script src="../bible-versions/js/WEB.js"></script>
    <script src="../common/js/bible-api.js"></script>
</head>
<body>
    <!-- ===== SEARCH TAB (main view) ===== -->
    <div class="tab-content" id="tabSearch">
        <div class="container">
            <div class="main-panel">
                <h1>Bible Query</h1>

                <!-- Bible Selection -->
                <div class="form-group">
                    <label for="bibleSelect">Bible:</label>
                    <select id="bibleSelect" class="form-control">
                        <!-- Options populated dynamically -->
                    </select>
                </div>

                <!-- Reference Input with Autocomplete -->
                <div class="form-group">
                    <label for="referenceInput">Reference:</label>
                    <div class="reference-input-wrapper">
                        <input type="text" id="referenceInput" class="form-control" 
                               placeholder="Type a book name..." autocomplete="off">
                    </div>
                </div>

                <!-- Autocomplete Dropdown -->
                <div id="autocompleteDropdown" class="autocomplete-dropdown">
                    <div id="autocompleteList" class="autocomplete-list">
                        <!-- Items populated dynamically -->
                    </div>
                </div>

                <!-- Submit Button -->
                <button id="displayBtn" class="btn btn-primary">Submit</button>
            </div>
        </div>
    </div>

    <!-- ===== BIBLE TAB ===== -->
    <div class="tab-content" id="tabBible" style="display:none;">
        <div class="container bible-container">
            <div class="main-panel bible-panel">
                <div class="bible-header">
                    <button id="bibleBackBtn" class="btn-back" title="Retour">&#8592;</button>
                    <h2 id="bibleTitle">Bible</h2>
                </div>
                <div id="versesContainer" class="verses-container">
                    <!-- Verses displayed here -->
                    <p class="empty-msg">No verses selected.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== LIST TAB ===== -->
    <div class="tab-content" id="tabList" style="display:none;">
        <div class="container">
            <div class="main-panel">
                <h1>List</h1>
                <p style="color:#888;text-align:center;padding:40px 0;">Coming soon...</p>
            </div>
        </div>
    </div>

    <!-- ===== THEME TAB ===== -->
    <div class="tab-content" id="tabTheme" style="display:none;">
        <div class="container">
            <div class="main-panel">
                <h1>Theme</h1>
                <p class="section-desc">Choose a theme for the Bible display (browser source).</p>
                <div class="theme-grid">
                    <div class="theme-card" data-theme="classic-dark">
                        <div class="theme-preview" style="background:linear-gradient(135deg,#1e1e32,#2d2d46);border-top:3px solid #0a84ff;">
                            <span style="color:#0a84ff;font-size:10px;font-weight:700;">JEAN 3:16</span>
                            <span style="color:#e8e8e8;font-size:9px;">Car Dieu a tant aim√©...</span>
                        </div>
                        <span class="theme-name">Classic Dark</span>
                    </div>
                    <div class="theme-card" data-theme="royal-purple">
                        <div class="theme-preview" style="background:linear-gradient(135deg,#30104a,#481c6e);border-top:3px solid #b44dff;">
                            <span style="color:#d89eff;font-size:10px;font-weight:700;">JEAN 3:16</span>
                            <span style="color:#f0e6ff;font-size:9px;">Car Dieu a tant aim√©...</span>
                        </div>
                        <span class="theme-name">Royal Purple</span>
                    </div>
                    <div class="theme-card" data-theme="warm-gold">
                        <div class="theme-preview" style="background:linear-gradient(135deg,#32230a,#4b3714);border-top:3px solid #d4a017;">
                            <span style="color:#f5c842;font-size:10px;font-weight:700;">JEAN 3:16</span>
                            <span style="color:#faebd7;font-size:9px;">Car Dieu a tant aim√©...</span>
                        </div>
                        <span class="theme-name">Warm Gold</span>
                    </div>
                    <div class="theme-card" data-theme="ocean-blue">
                        <div class="theme-preview" style="background:linear-gradient(135deg,#0a1e3c,#0f325a);border-top:3px solid #00b4d8;">
                            <span style="color:#48cae4;font-size:10px;font-weight:700;">JEAN 3:16</span>
                            <span style="color:#caf0f8;font-size:9px;">Car Dieu a tant aim√©...</span>
                        </div>
                        <span class="theme-name">Ocean Blue</span>
                    </div>
                    <div class="theme-card" data-theme="clean-white">
                        <div class="theme-preview" style="background:linear-gradient(135deg,#f5f5f5,#ffffff);border-top:3px solid #333;">
                            <span style="color:#222;font-size:10px;font-weight:700;">JEAN 3:16</span>
                            <span style="color:#333;font-size:9px;">Car Dieu a tant aim√©...</span>
                        </div>
                        <span class="theme-name">Clean White</span>
                    </div>
                    <div class="theme-card" data-theme="forest-green">
                        <div class="theme-preview" style="background:linear-gradient(135deg,#0f2819,#193c23);border-top:3px solid #2ecc71;">
                            <span style="color:#55efc4;font-size:10px;font-weight:700;">JEAN 3:16</span>
                            <span style="color:#d4efdf;font-size:9px;">Car Dieu a tant aim√©...</span>
                        </div>
                        <span class="theme-name">Forest Green</span>
                    </div>
                    <div class="theme-card" data-theme="crimson">
                        <div class="theme-preview" style="background:linear-gradient(135deg,#370a0f,#551419);border-top:3px solid #e74c3c;">
                            <span style="color:#ff7675;font-size:10px;font-weight:700;">JEAN 3:16</span>
                            <span style="color:#fce4e4;font-size:9px;">Car Dieu a tant aim√©...</span>
                        </div>
                        <span class="theme-name">Crimson</span>
                    </div>
                    <div class="theme-card" data-theme="transparent">
                        <div class="theme-preview" style="background:rgba(0,0,0,0.55);border-top:none;">
                            <span style="color:#fff;font-size:10px;font-weight:700;">JEAN 3:16</span>
                            <span style="color:#f0f0f0;font-size:9px;">Car Dieu a tant aim√©...</span>
                        </div>
                        <span class="theme-name">Transparent</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== SETTINGS TAB ===== -->
    <div class="tab-content" id="tabSettings" style="display:none;">
        <div class="container">
            <div class="main-panel settings-panel">
                <h1>Settings</h1>

                <!-- Reference Font Size -->
                <div class="setting-row">
                    <div class="setting-info">
                        <span class="setting-title">Reference Font Size</span>
                        <span class="setting-desc">Scales the font size of the verse reference display.</span>
                    </div>
                    <div class="setting-control">
                        <div class="spin-control">
                            <input type="number" id="refFontSizeInput" class="spin-input" value="20" min="10" max="48">
                            <div class="spin-buttons">
                                <button class="spin-up" id="refFontIncrease">‚ñ≤</button>
                                <button class="spin-down" id="refFontDecrease">‚ñº</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Verse Font Size -->
                <div class="setting-row">
                    <div class="setting-info">
                        <span class="setting-title">Verse Font Size</span>
                        <span class="setting-desc">Scales the font size of displayed Bible verses.</span>
                    </div>
                    <div class="setting-control">
                        <div class="spin-control">
                            <input type="number" id="verseFontSizeInput" class="spin-input" value="18" min="10" max="48">
                            <div class="spin-buttons">
                                <button class="spin-up" id="verseFontIncrease">‚ñ≤</button>
                                <button class="spin-down" id="verseFontDecrease">‚ñº</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Line Spacing -->
                <div class="setting-row">
                    <div class="setting-info">
                        <span class="setting-title">Line Spacing</span>
                        <span class="setting-desc">Controls the line height of the verse text.</span>
                    </div>
                    <div class="setting-control">
                        <div class="spin-control">
                            <input type="number" id="lineHeightInput" class="spin-input" value="1.6" min="1.0" max="3.0" step="0.1">
                            <div class="spin-buttons">
                                <button class="spin-up" id="lineHeightIncrease">‚ñ≤</button>
                                <button class="spin-down" id="lineHeightDecrease">‚ñº</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Maximum number of lines -->
                <div class="setting-row">
                    <div class="setting-info">
                        <span class="setting-title">Maximum number of lines</span>
                        <span class="setting-desc">Splits Bible verses into different slides if there are too many lines. Leave at 0 for no limit.</span>
                    </div>
                    <div class="setting-control">
                        <div class="spin-control">
                            <input type="number" id="maxLinesInput" class="spin-input" value="0" min="0" max="10">
                            <div class="spin-buttons">
                                <button class="spin-up" id="maxLinesIncrease">‚ñ≤</button>
                                <button class="spin-down" id="maxLinesDecrease">‚ñº</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Opacity -->
                <div class="setting-row">
                    <div class="setting-info">
                        <span class="setting-title">Opacity</span>
                        <span class="setting-desc">Controls the transparency of the verse display block.</span>
                    </div>
                    <div class="setting-control">
                        <div class="spin-control">
                            <input type="number" id="opacityInput" class="spin-input" value="100" min="10" max="100" step="5">
                            <div class="spin-buttons">
                                <button class="spin-up" id="opacityIncrease">‚ñ≤</button>
                                <button class="spin-down" id="opacityDecrease">‚ñº</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Text Alignment -->
                <div class="setting-row">
                    <div class="setting-info">
                        <span class="setting-title">Text Alignment</span>
                        <span class="setting-desc">Sets the text alignment for the verse display.</span>
                    </div>
                    <div class="setting-control">
                        <select id="alignmentSelect" class="setting-select">
                            <option value="left">Left</option>
                            <option value="center" selected>Center</option>
                            <option value="right">Right</option>
                        </select>
                    </div>
                </div>

                <!-- Transition Effect -->
                <div class="setting-row">
                    <div class="setting-info">
                        <span class="setting-title">Transition Effect</span>
                        <span class="setting-desc">Animation used when displaying and hiding verses.</span>
                    </div>
                    <div class="setting-control">
                        <select id="transitionSelect" class="setting-select">
                            <option value="fade">Fade</option>
                            <option value="slide-up">Slide Up</option>
                            <option value="slide-down">Slide Down</option>
                            <option value="slide-left">Slide Left</option>
                            <option value="zoom">Zoom</option>
                            <option value="none">None</option>
                        </select>
                    </div>
                </div>

                <!-- Auto-hide -->
                <div class="setting-row">
                    <div class="setting-info">
                        <span class="setting-title">Auto-hide Verse</span>
                        <span class="setting-desc">Automatically hides the verse after a set duration.</span>
                    </div>
                    <div class="setting-control">
                        <label class="toggle-switch">
                            <input type="checkbox" id="autoHideToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- Auto-hide Timer -->
                <div class="setting-row" id="autoHideTimerSection" style="display:none;">
                    <div class="setting-info">
                        <span class="setting-title">Auto-hide Delay</span>
                        <span class="setting-desc">Number of seconds before the verse disappears.</span>
                    </div>
                    <div class="setting-control">
                        <div class="spin-control">
                            <input type="number" id="timerInput" class="spin-input" value="5" min="2" max="20">
                            <div class="spin-buttons">
                                <button class="spin-up" id="timerIncrease">‚ñ≤</button>
                                <button class="spin-down" id="timerDecrease">‚ñº</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Current Theme -->
                <div class="setting-row">
                    <div class="setting-info">
                        <span class="setting-title">Current Theme</span>
                        <span class="setting-desc">Visual style applied to the browser source display.</span>
                    </div>
                    <div class="setting-control">
                        <div class="theme-select-row">
                            <span id="currentThemeName" class="current-theme-label">Classic Dark</span>
                            <button id="goToThemes" class="btn-link">Change ‚Üí</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation Bar -->
    <div class="bottom-nav">
        <button class="nav-btn active" data-tab="tabSearch" title="Rechercher">
            <span class="icon">üîç</span>
            <span class="label">Search</span>
        </button>
        <button class="nav-btn" data-tab="tabBible" title="Bible">
            <span class="icon">üìñ</span>
            <span class="label">Bible</span>
        </button>
        <button class="nav-btn" data-tab="tabList" title="Liste">
            <span class="icon">‚ò∞</span>
            <span class="label">List</span>
        </button>
        <button class="nav-btn" data-tab="tabTheme" title="Th√®me">
            <span class="icon">üé®</span>
            <span class="label">Theme</span>
        </button>
        <button class="nav-btn" data-tab="tabSettings" title="Param√®tres">
            <span class="icon">‚öôÔ∏è</span>
            <span class="label">Settings</span>
        </button>
    </div>

    <script>
        // ====== State ======
        let selectedBook = null;
        let isLoading = false;

        // ====== Tab Navigation ======
        function switchTab(tabId) {
            $('.tab-content').hide();
            $('#' + tabId).show();
            $('.nav-btn').removeClass('active');
            $(`.nav-btn[data-tab="${tabId}"]`).addClass('active');
        }

        $('.nav-btn').click(function() {
            const tabId = $(this).data('tab');
            switchTab(tabId);
        });

        // ====== Bible Version Loader ======
        function initVersions() {
            console.log('Initializing Bible versions...');
            const versions = getAvailableVersions();
            const select = $('#bibleSelect');
            select.empty();

            if (versions.length === 0) {
                select.append('<option value="">-- No Bible found --</option>');
                console.error('No Bible versions found. Check that JS files are loaded.');
                return;
            }

            versions.forEach((v, idx) => {
                select.append(`<option value="${idx}">${v.name}</option>`);
            });

            console.log(`Dropdown populated with ${versions.length} versions`);

            // Load the first version by default
            if (versions.length > 0) {
                loadBible(versions[0].key, versions[0].mappingKey);
                console.log('Default Bible loaded:', versions[0].name);
            }
        }

        // When Bible version changes, reload
        $('#bibleSelect').on('change', function() {
            const idx = parseInt($(this).val());
            if (availableVersions[idx]) {
                isLoading = true;
                $('#referenceInput').val('');
                hideAutocomplete();
                loadBible(availableVersions[idx].key, availableVersions[idx].mappingKey);
                isLoading = false;
            }
        });

        // ====== Autocomplete ======
        function showAutocomplete(items) {
            const list = $('#autocompleteList');
            list.empty();

            if (items.length === 0) {
                list.html('<div class="autocomplete-item no-results">No book found</div>');
            } else {
                items.forEach(bookName => {
                    const item = $(`<div class="autocomplete-item">${bookName}</div>`);
                    item.on('mousedown', function(e) {
                        e.preventDefault(); // prevent blur
                        selectBook(bookName);
                    });
                    list.append(item);
                });
            }

            $('#autocompleteDropdown').addClass('show');
        }

        function hideAutocomplete() {
            $('#autocompleteDropdown').removeClass('show');
        }

        function selectBook(bookName) {
            selectedBook = bookName;
            $('#referenceInput').val(bookName + ' ');
            hideAutocomplete();
            // Focus back on input so user can type chapter
            $('#referenceInput').focus();
        }

        // ====== Reference Input Handler ======
        $('#referenceInput').on('input', function() {
            const input = $(this).val().trim();

            if (input.length === 0) {
                hideAutocomplete();
                selectedBook = null;
                return;
            }

            // Check if input contains a chapter number (book has been selected)
            const parsed = parseReference(input);
            if (parsed && findBook(parsed.book)) {
                // User is typing chapter/verse, hide autocomplete
                hideAutocomplete();
                return;
            }

            // Check if the input exactly matches a book (user selected from list)
            const exactBook = bibleBookNames.find(b => b.toLowerCase() === input.toLowerCase());
            if (exactBook) {
                selectedBook = exactBook;
                hideAutocomplete();
                return;
            }

            // Otherwise, show autocomplete suggestions
            const matches = searchBooks(input);
            showAutocomplete(matches);
        });

        $('#referenceInput').on('focus', function() {
            const input = $(this).val().trim();
            if (input.length > 0) {
                const parsed = parseReference(input);
                if (!parsed || !findBook(parsed.book)) {
                    const matches = searchBooks(input);
                    if (matches.length > 0) {
                        showAutocomplete(matches);
                    }
                }
            }
        });

        $('#referenceInput').on('blur', function() {
            setTimeout(() => hideAutocomplete(), 150);
        });

        // ====== Submit / Display ======
        function submitReference() {
            const reference = $('#referenceInput').val().trim();
            if (!reference) {
                return;
            }

            const parsed = parseReference(reference);

            if (parsed) {
                const bookKey = findBook(parsed.book);
                if (!bookKey) {
                    showBibleError('Book not found: ' + parsed.book);
                    return;
                }

                const localName = getLocalizedBookName(bookKey);

                if (parsed.verse === null) {
                    // Whole chapter: "Book Chapter"
                    const verses = getChapter(bookKey, parsed.chapter);
                    if (verses.length > 0) {
                        displayVerses(verses, `${localName} ${parsed.chapter}`);
                    } else {
                        showBibleError(`Chapter ${parsed.chapter} not found in ${localName}`);
                    }
                } else {
                    // Specific verse or range
                    const verses = getVersesByReference(reference);
                    if (verses) {
                        const rangeStr = parsed.verse === parsed.verseEnd
                            ? `${localName} ${parsed.chapter}:${parsed.verse}`
                            : `${localName} ${parsed.chapter}:${parsed.verse}-${parsed.verseEnd}`;
                        displayVerses(verses, rangeStr);
                    } else {
                        showBibleError(`Verse(s) not found: ${reference}`);
                    }
                }
            } else {
                // Maybe just a book name? Show all chapters info
                const bookKey = findBook(reference);
                if (bookKey) {
                    const localName = getLocalizedBookName(bookKey);
                    // Default to chapter 1
                    const verses = getChapter(bookKey, '1');
                    if (verses.length > 0) {
                        displayVerses(verses, `${localName} 1`);
                    } else {
                        showBibleError(`No data found for ${localName}`);
                    }
                } else {
                    showBibleError('Invalid reference format. Try: Gen√®se 1 or Jean 3:16');
                }
            }
        }

        function displayVerses(verses, title) {
            const container = $('#versesContainer');
            container.empty();

            // Get the current Bible version name
            const idx = parseInt($('#bibleSelect').val());
            const versionName = availableVersions[idx] ? availableVersions[idx].name : '';

            $('#bibleTitle').text(title);

            verses.forEach(v => {
                const verseEl = $(`
                    <div class="verse-item" data-ref="${v.reference || ''}">
                        <span class="verse-num">${v.verse}</span>
                        <span class="verse-text">${v.text}</span>
                    </div>
                `);

                // Click to select/send verse
                verseEl.on('click', function() {
                    const wasSelected = $(this).hasClass('selected');
                    
                    if (wasSelected) {
                        // Deselect and clear browser-source
                        $(this).removeClass('selected');
                        $(this).find('.verse-chunks-nav').remove();
                        $(this).find('.verse-text').text(v.text);
                        localStorage.setItem('currentVerseReference', '');
                        localStorage.setItem('currentVerseText', '');
                        localStorage.setItem('currentVerseSource', '');
                    } else {
                        // Deselect previous
                        $('.verse-item').removeClass('selected');
                        $('.verse-chunks-nav').remove();
                        // Restore full text on previously selected items
                        $('.verse-item').each(function() {
                            const origText = $(this).data('fulltext');
                            if (origText) $(this).find('.verse-text').text(origText);
                        });

                        $(this).addClass('selected');

                        // Check max lines and split if needed
                        const maxLines = parseInt(localStorage.getItem('bibleMaxLines') || '0');
                        if (maxLines > 0) {
                            const chunks = splitTextIntoChunks(v.text, maxLines);
                            if (chunks.length > 1) {
                                // Store data for navigation
                                $(this).data('fulltext', v.text);
                                $(this).data('chunks', chunks);
                                $(this).data('chunk-index', 0);
                                $(this).data('chunk-ref', v.reference || title);
                                $(this).data('chunk-version', versionName);

                                // Show chunk 1 with nav
                                showVerseChunk($(this), 0);
                                return;
                            }
                        }
                        
                        // Normal (no chunking needed)
                        localStorage.setItem('currentVerseReference', v.reference || `${title}`);
                        localStorage.setItem('currentVerseText', v.text);
                        localStorage.setItem('currentVerseSource', versionName);
                    }
                });

                container.append(verseEl);
            });

            // Switch to Bible tab
            switchTab('tabBible');
        }

        // Split text into chunks that approximate the max line count
        function splitTextIntoChunks(text, maxLines) {
            // Estimate ~60 chars per line as a rough average for the browser-source display
            const charsPerLine = 55;
            const chunkSize = maxLines * charsPerLine;
            
            if (text.length <= chunkSize) return [text];
            
            const chunks = [];
            let remaining = text;
            
            while (remaining.length > 0) {
                if (remaining.length <= chunkSize) {
                    chunks.push(remaining.trim());
                    break;
                }
                
                // Find a good break point (space, comma, semicolon) near the chunk size
                let breakAt = chunkSize;
                // Search backward for a space to avoid cutting words
                while (breakAt > chunkSize * 0.7 && remaining[breakAt] !== ' ') {
                    breakAt--;
                }
                if (breakAt <= chunkSize * 0.7) breakAt = chunkSize; // fallback
                
                chunks.push(remaining.substring(0, breakAt).trim());
                remaining = remaining.substring(breakAt).trim();
            }
            
            return chunks;
        }

        // Show a specific chunk of a verse
        function showVerseChunk(verseEl, chunkIdx) {
            const chunks = verseEl.data('chunks');
            const ref = verseEl.data('chunk-ref');
            const versionName = verseEl.data('chunk-version');
            
            chunkIdx = Math.max(0, Math.min(chunks.length - 1, chunkIdx));
            verseEl.data('chunk-index', chunkIdx);

            // Update text display in control panel
            const displayText = chunks[chunkIdx] + (chunkIdx < chunks.length - 1 ? ' ...' : '');
            verseEl.find('.verse-text').html(
                `<span class="chunk-text">${displayText}</span>`
            );

            // Remove old nav, add new
            verseEl.find('.verse-chunks-nav').remove();
            const nav = $(`
                <div class="verse-chunks-nav">
                    <button class="chunk-btn chunk-prev" ${chunkIdx === 0 ? 'disabled' : ''}>‚óÄ</button>
                    <span class="chunk-indicator">${chunkIdx + 1} / ${chunks.length}</span>
                    <button class="chunk-btn chunk-next" ${chunkIdx === chunks.length - 1 ? 'disabled' : ''}>‚ñ∂</button>
                </div>
            `);

            nav.find('.chunk-prev').on('click', function(e) {
                e.stopPropagation();
                showVerseChunk(verseEl, chunkIdx - 1);
            });

            nav.find('.chunk-next').on('click', function(e) {
                e.stopPropagation();
                showVerseChunk(verseEl, chunkIdx + 1);
            });

            verseEl.append(nav);

            // Send chunk to browser-source
            const suffix = chunks.length > 1 ? ` (${chunkIdx + 1}/${chunks.length})` : '';
            localStorage.setItem('currentVerseReference', ref + suffix);
            localStorage.setItem('currentVerseText', chunks[chunkIdx]);
            localStorage.setItem('currentVerseSource', versionName);
        }

        function showBibleError(msg) {
            const container = $('#versesContainer');
            container.html(`<div class="bible-error"><p>‚ö†Ô∏è ${msg}</p></div>`);
            switchTab('tabBible');
        }

        // Submit button
        $('#displayBtn').click(function() {
            submitReference();
        });

        // Enter key
        $('#referenceInput').keypress(function(e) {
            if (e.which === 13) {
                hideAutocomplete();
                submitReference();
            }
        });

        // Back button in Bible tab
        $('#bibleBackBtn').click(function() {
            switchTab('tabSearch');
        });

        // ====== Init ======
        $(document).ready(function() {
            initVersions();
            loadSettings();
        });

        // ====== Theme Selection ======
        $('.theme-card').click(function() {
            const theme = $(this).data('theme');
            $('.theme-card').removeClass('selected');
            $(this).addClass('selected');
            localStorage.setItem('bibleTheme', theme);
            $('#currentThemeName').text($(this).find('.theme-name').text());
        });

        // Highlight currently saved theme on load
        function loadSettings() {
            const savedTheme = localStorage.getItem('bibleTheme') || 'classic-dark';
            $(`.theme-card[data-theme="${savedTheme}"]`).addClass('selected');
            $('#currentThemeName').text($(`.theme-card[data-theme="${savedTheme}"] .theme-name`).text() || 'Classic Dark');

            $('#refFontSizeInput').val(localStorage.getItem('bibleRefFontSize') || '20');
            $('#verseFontSizeInput').val(localStorage.getItem('bibleVerseFontSize') || '18');
            $('#lineHeightInput').val(localStorage.getItem('bibleLineHeight') || '1.6');
            $('#maxLinesInput').val(localStorage.getItem('bibleMaxLines') || '0');
            $('#opacityInput').val(localStorage.getItem('bibleOpacity') || '100');
            $('#alignmentSelect').val(localStorage.getItem('bibleAlignment') || 'center');
            $('#transitionSelect').val(localStorage.getItem('bibleTransition') || 'fade');

            const savedAutoHide = localStorage.getItem('bibleAutoHide') === 'true';
            $('#autoHideToggle').prop('checked', savedAutoHide);
            $('#autoHideTimerSection').toggle(savedAutoHide);
            $('#timerInput').val(localStorage.getItem('bibleAutoHideTimer') || '5');
        }

        // ====== Settings: Spin controls ======
        function bindSpinControl(inputId, upId, downId, storageKey, step, min, max, isFloat) {
            const $input = $(`#${inputId}`);

            function save() {
                let val = isFloat ? parseFloat($input.val()) : parseInt($input.val());
                val = Math.max(min, Math.min(max, isNaN(val) ? min : val));
                $input.val(isFloat ? val.toFixed(1) : val);
                localStorage.setItem(storageKey, isFloat ? val.toFixed(1) : val.toString());
            }

            $input.on('change', save);

            $(`#${upId}`).click(function() {
                let val = isFloat ? parseFloat($input.val()) : parseInt($input.val());
                val = Math.min(max, val + step);
                $input.val(isFloat ? val.toFixed(1) : val);
                save();
            });

            $(`#${downId}`).click(function() {
                let val = isFloat ? parseFloat($input.val()) : parseInt($input.val());
                val = Math.max(min, val - step);
                $input.val(isFloat ? val.toFixed(1) : val);
                save();
            });
        }

        bindSpinControl('refFontSizeInput', 'refFontIncrease', 'refFontDecrease', 'bibleRefFontSize', 1, 10, 48, false);
        bindSpinControl('verseFontSizeInput', 'verseFontIncrease', 'verseFontDecrease', 'bibleVerseFontSize', 1, 10, 48, false);
        bindSpinControl('lineHeightInput', 'lineHeightIncrease', 'lineHeightDecrease', 'bibleLineHeight', 0.1, 1.0, 3.0, true);
        bindSpinControl('maxLinesInput', 'maxLinesIncrease', 'maxLinesDecrease', 'bibleMaxLines', 1, 0, 10, false);
        bindSpinControl('opacityInput', 'opacityIncrease', 'opacityDecrease', 'bibleOpacity', 5, 10, 100, false);
        bindSpinControl('timerInput', 'timerIncrease', 'timerDecrease', 'bibleAutoHideTimer', 1, 2, 20, false);

        // ====== Settings: Select controls ======
        $('#alignmentSelect').on('change', function() {
            localStorage.setItem('bibleAlignment', $(this).val());
        });

        $('#transitionSelect').on('change', function() {
            localStorage.setItem('bibleTransition', $(this).val());
        });

        // ====== Settings: Auto-hide ======
        $('#autoHideToggle').change(function() {
            const enabled = $(this).is(':checked');
            localStorage.setItem('bibleAutoHide', enabled.toString());
            $('#autoHideTimerSection').toggle(enabled);
        });

        // ====== Settings: Go to themes ======
        $('#goToThemes').click(function() {
            switchTab('tabTheme');
        });
    </script>
</body>
</html>