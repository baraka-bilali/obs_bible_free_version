<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bible Display - OBS Browser Source</title>
    <link rel="stylesheet" href="../common/css/style-source.css">
    <script src="../common/js/jquery.js"></script>
</head>
<body>
    <div class="bible-display-container">
        <div class="verse-display" id="verseDisplay">
            <div class="verse-content">
                <h2 class="verse-reference" id="verseReference"></h2>
                <p class="verse-text" id="verseText"></p>
            </div>
        </div>
    </div>

    <script>
        let lastReference = '';
        let lastText = '';
        let autoHideTimeout = null;
        let isDisplayVisible = false; // Track whether the block is currently showing

        function applySettings() {
            const refFontSize = localStorage.getItem('bibleRefFontSize') || '20';
            const verseFontSize = localStorage.getItem('bibleVerseFontSize') || '18';
            const lineHeight = localStorage.getItem('bibleLineHeight') || '1.6';
            const alignment = localStorage.getItem('bibleAlignment') || 'center';
            const theme = localStorage.getItem('bibleTheme') || 'classic-dark';
            const opacity = localStorage.getItem('bibleOpacity') || '100';
            const maxLines = parseInt(localStorage.getItem('bibleMaxLines') || '0');

            // Font sizes (independent)
            $('#verseReference').css('font-size', refFontSize + 'px');
            $('#verseText').css('font-size', verseFontSize + 'px');

            // Line spacing
            $('#verseText').css('line-height', lineHeight);

            // Alignment
            $('#verseDisplay').css('text-align', alignment);

            // Opacity
            $('#verseDisplay').css('opacity', parseFloat(opacity) / 100);

            // Max lines (text clamp)
            if (maxLines > 0) {
                $('#verseText').css({
                    'display': '-webkit-box',
                    '-webkit-line-clamp': maxLines.toString(),
                    '-webkit-box-orient': 'vertical',
                    'overflow': 'hidden',
                    'text-overflow': 'ellipsis'
                });
            } else {
                // Remove clamp (auto/unlimited)
                $('#verseText').css({
                    'display': 'block',
                    '-webkit-line-clamp': 'unset',
                    '-webkit-box-orient': 'unset',
                    'overflow': 'visible',
                    'text-overflow': 'clip'
                });
            }

            // Theme
            $('body').attr('data-theme', theme);
        }

        function hideVerse() {
            if (!isDisplayVisible) return;

            // Get transition type for fade-out
            const transition = localStorage.getItem('bibleTransition') || 'fade';
            
            // Add fade-out class based on transition type
            $('#verseDisplay').removeClass('fade-in slide-up slide-down slide-left zoom none');
            $('#verseDisplay').addClass(transition + '-out');
            
            // Wait for animation to complete before hiding completely
            setTimeout(function() {
                $('#verseReference').text('');
                $('#verseText').text('');
                $('#verseDisplay').removeClass(transition + '-out');
                $('#verseDisplay').addClass('hidden'); // Hide the entire block
                lastReference = '';
                lastText = '';
                isDisplayVisible = false;
            }, 600); // Match animation duration
        }

        function updateVerseDisplay() {
            const reference = localStorage.getItem('currentVerseReference') || '';
            const text = localStorage.getItem('currentVerseText') || '';
            const source = localStorage.getItem('currentVerseSource') || '';

            // Check if verse was cleared (deselected)
            if (!reference && !text && (lastReference || lastText)) {
                hideVerse();
                return;
            }

            // Only update if something changed
            if (reference === lastReference && text === lastText) {
                // Still apply settings in case they changed
                applySettings();
                return;
            }

            lastReference = reference;
            lastText = text;

            // Clear any existing auto-hide timer
            if (autoHideTimeout) {
                clearTimeout(autoHideTimeout);
                autoHideTimeout = null;
            }

            if (reference && text) {
                // Is this the first verse appearing (hidden → visible)?
                const isEntrance = !isDisplayVisible;

                // Show the block if it was hidden
                $('#verseDisplay').removeClass('hidden');
                
                // Extract abbreviation from parentheses (e.g. "Louis Segond (LSG)" → "LSG")
                const parenMatch = source.match(/\(([^)]+)\)/);
                const abbr = source ? ' (' + (parenMatch ? parenMatch[1].toUpperCase() : source.substring(0, 3).toUpperCase()) + ')' : '';
                $('#verseReference').text(reference + abbr);
                $('#verseText').text(text);

                // Entrance transition ONLY when going from nothing → first verse
                // Switching between verses = instant update, no animation
                if (isEntrance) {
                    const transition = localStorage.getItem('bibleTransition') || 'fade';
                    $('#verseDisplay').removeClass('fade-in slide-up slide-down slide-left zoom none fade-out slide-up-out slide-down-out slide-left-out zoom-out');
                    void document.getElementById('verseDisplay').offsetWidth;
                    $('#verseDisplay').addClass(transition);
                }

                isDisplayVisible = true;

                // Auto-hide if enabled
                const autoHide = localStorage.getItem('bibleAutoHide') === 'true';
                if (autoHide) {
                    const timer = parseInt(localStorage.getItem('bibleAutoHideTimer') || '5') * 1000;
                    autoHideTimeout = setTimeout(hideVerse, timer);
                }
            }

            applySettings();
        }

        // Listen for storage events (from control panel)
        window.addEventListener('storage', function(e) {
            if (['currentVerseReference', 'currentVerseText', 'currentVerseSource',
                 'bibleRefFontSize', 'bibleVerseFontSize', 'bibleLineHeight', 'bibleAlignment', 'bibleTheme',
                 'bibleOpacity', 'bibleMaxLines', 'bibleTransition', 'bibleAutoHide', 'bibleAutoHideTimer'].includes(e.key)) {
                updateVerseDisplay();
            }
        });

        // Poll as fallback (same-tab localStorage doesn't fire storage event)
        setInterval(updateVerseDisplay, 1000);

        // Initial
        updateVerseDisplay();
    </script>
</body>
</html>
