<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bible Display - OBS Browser Source</title>
    <link rel="stylesheet" href="../common/css/style-source.css">
    <script src="../common/js/jquery.js"></script>
</head>
<body>
    <div class="bible-display-container">
        <div class="verse-display" id="verseDisplay">
            <div class="verse-content">
                <h2 class="verse-reference" id="verseReference"></h2>
                <p class="verse-text" id="verseText"></p>
            </div>
        </div>
    </div>

    <script>
        let lastReference = '';
        let lastText = '';

        function applySettings() {
            const refFontSize = localStorage.getItem('bibleRefFontSize') || '20';
            const verseFontSize = localStorage.getItem('bibleVerseFontSize') || '18';
            const lineHeight = localStorage.getItem('bibleLineHeight') || '1.6';
            const alignment = localStorage.getItem('bibleAlignment') || 'center';
            const theme = localStorage.getItem('bibleTheme') || 'classic-dark';

            // Font sizes (independent)
            $('#verseReference').css('font-size', refFontSize + 'px');
            $('#verseText').css('font-size', verseFontSize + 'px');

            // Line spacing
            $('#verseText').css('line-height', lineHeight);

            // Alignment
            $('#verseDisplay').css('text-align', alignment);

            // Theme
            $('body').attr('data-theme', theme);
        }

        function updateVerseDisplay() {
            const reference = localStorage.getItem('currentVerseReference') || '';
            const text = localStorage.getItem('currentVerseText') || '';
            const source = localStorage.getItem('currentVerseSource') || '';

            // Only update if something changed
            if (reference === lastReference && text === lastText) {
                // Still apply settings in case they changed
                applySettings();
                return;
            }

            lastReference = reference;
            lastText = text;

            if (reference && text) {
                // Extract abbreviation from parentheses (e.g. "Louis Segond (LSG)" â†’ "LSG")
                const parenMatch = source.match(/\(([^)]+)\)/);
                const abbr = source ? ' (' + (parenMatch ? parenMatch[1].toUpperCase() : source.substring(0, 3).toUpperCase()) + ')' : '';
                $('#verseReference').text(reference + abbr);
                $('#verseText').text(text);

                // Animate only on change
                $('#verseDisplay').removeClass('fade-in');
                void document.getElementById('verseDisplay').offsetWidth; // force reflow
                $('#verseDisplay').addClass('fade-in');
            }

            applySettings();
        }

        // Listen for storage events (from control panel)
        window.addEventListener('storage', function(e) {
            if (['currentVerseReference', 'currentVerseText', 'currentVerseSource',
                 'bibleRefFontSize', 'bibleVerseFontSize', 'bibleLineHeight', 'bibleAlignment', 'bibleTheme'].includes(e.key)) {
                updateVerseDisplay();
            }
        });

        // Poll as fallback (same-tab localStorage doesn't fire storage event)
        setInterval(updateVerseDisplay, 1000);

        // Initial
        updateVerseDisplay();
    </script>
</body>
</html>
